{"version":3,"sources":["webpack://mfModules.[name]/./src/mobile.editor.overlay/AbuseFilterOverlay.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/AbuseFilterPanel.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/BlockMessageDetails.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/EditorGateway.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/EditorOverlayBase.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/SourceEditorOverlay.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/VisualEditorOverlay.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/blockMessageDrawer.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/identifyLeadParagraph.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/mobile.editor.overlay.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/saveFailureMessage.js","webpack://mfModules.[name]/./src/mobile.editor.overlay/schemaEditAttemptStep.js"],"names":["Button","require","util","mfExtend","Overlay","AbuseFilterOverlay","props","call","this","extend","className","defaults","prototype","confirmButton","additionalClassNames","progressive","templatePartials","content","template","postRender","apply","$el","find","attr","append","options","module","exports","View","AbuseFilterPanel","isDisallowed","overlayManager","readMoreMsg","mw","msg","show","type","message","add","text","removeClass","hide","addClass","userIcon","tagName","name","okButton","label","BlockMessageDetails","prepend","createDetailsAnchorHref","getUrl","wpTarget","blockId","createDetailsAnchorLabel","createTitle","partial","reasonHeader","creatorHeader","user","get","expiryHeader","parseSaveError","actionParams","EditorGateway","api","title","sectionId","oldId","isNewPage","undefined","fromModified","hasChanged","getBlockInfo","pageObj","blockedError","actions","edit","Array","isArray","some","error","indexOf","code","data","blockinfo","loader","load","getContent","self","resolve","Deferred","prop","rvprop","titles","intestactions","intestactionsdetail","rvstartid","isNumeric","rvsection","then","resp","revision","reject","query","pages","missing","revisions","timestamp","originalContent","setContent","setPrependText","prependtext","save","result","apiOptions","action","summary","captchaid","captchaId","captchaword","captchaWord","basetimestamp","starttimestamp","section","postWithToken","newrevid","saveContent","abortPreview","_pending","abort","getPreview","request","sectionLine","sectionpreview","disableeditsection","pst","mobileformat","post","parse","sections","anchor","line","id","promise","headers","PageGateway","icons","toast","saveFailureMessage","MessageBox","mwUser","EditVeTool","toolGroup","config","classes","super","EditorOverlayBase","params","onBeforeExit","bind","isBorderBox","events","click .back","click .continue","click .submit","click .anonymous","placeholder","summaryRequestMsg","pageGateway","editCount","isNewEditor","sessionId","OO","inheritClass","ui","Tool","static","icon","group","onSelect","onUpdateState","hasToolbar","continueMsg","closeMsg","summaryMsg","captchaMsg","captchaTryAgainMsg","switchMsg","confirmMsg","licenseMsg","log","track","editor_interface","editor","editing_session_id","logFeatureUse","confirmSave","window","confirm","onSaveComplete","newRevId","$window","getWindow","saved","invalidatePage","showOnPageReload","revision_id","location","hash","off","reload","onSaveFailure","key","details","editconflict","wasdeleted","abusefilter-disallowed","captcha","spamprotectiontext","titleblacklist-forbidden-edit","reportError","heading","errorNotice","$errorNoticeContainer","html","hideErrorNotice","empty","onStageChanges","showHidden","scrollTo","onSaveBegin","confirmAborted","preRender","formHeader","render","editSwitcher","editingMsg","readOnly","disabled","skipPreview","saveButtonMessage","cancel","saveHeader","previewingMsg","savingHeader","nextStep","spinner","allowCloseWindow","confirmCloseWindow","test","namespace","hook","fire","onClickBack","onClickSubmit","onClickContinue","onClickAnonymous","exit","windowManager","switching","getWindowManager","addWindows","widgets","AbandonEditDialog","openWindow","closed","mechanism","release","target","edited","createAnonWarning","$actions","$","$anonWarning","returnto","returnTo","returntoquery","warning","queryParams","signupParams","signupQueryParams","anonymousEditorActions","block","href","map","parseBlockInfo","blockInfo","expiry","reason","moment","blockpartial","creator","blockedby","url","Title","makeTitle","duration","blockid","blockexpiry","format","to","blockreason","wikitext","parser","ast","jqueryMsg","wikiTextToAst","emitter","emit","e","jqueryMsgParse","escape","escaped","getOptionsForSwitch","switched","currentPageHTMLParser","fakeScroll","titleObj","isAnon","contentLang","contentDir","handleCaptcha","$input","captchaShown","val","setTimeout","mime","detach","question","Section","blockMessageDrawer","VisualEditorOverlay","SourceEditorOverlay","dataPromise","isFirefox","navigator","userAgent","gateway","isVisualEditorEnabled","input .wikitext-editor","ns","namespaces","onInputWikitextEditor","arguments","_hidePreview","showAnonWarning","using","switchToolbar","switchWindow","toolFactory","ToolFactory","toolGroupFactory","ToolGroupFactory","register","libs","ve","MWEditModeVisualTool","MWEditModeSourceTool","Toolbar","on","mode","canSwitch","fullRestbaseUrl","allowLossySwitching","_switchToVisualEditor","WindowManager","SwitchConfirmDialog","$element","appendTo","document","body","destroy","setup","include","$preview","$content","$anonHiddenButtons","hideSpinner","abuseFilterPanel","_resizeEditor","_loadContent","showSpinner","hideSpinnerAndShowPreview","scrollTop","getDocument","mainpage","parsedText","parsedSectionLine","parseHTML","el","container","$scrollContainer","Element","getClosestScrollableContainer","length","css","height","toggle","feature","storage","set","targetLoader","addPlugin","loadModules","requestPageData","targetName","modified","replaceCurrent","_showAbuseFilter","router","identifyLeadParagraph","editHeader","destroyTarget","overlay","init","targetFactory","create","once","scrollToLeadParagraph","checkForBlocks","editLead","readLead","offset","surface","getSurface","getMode","getView","$attachedRootNode","getLeadSectionElement","top","switchToEditor","visualeditor","switchToSourceEditor","navigateTo","path","useReplaceState","getModel","hasBeenModified","Drawer","Icon","children","$body","$paragraphs","i","node","isNonLeadParagraph","$coords","textContent","isNotEmptyNode","m","schemaEditAttemptStep","define","readonlyreason","info","trackdebug","getParamValue","exists","Schema","eventLog","sampleRate","actionPrefixMap","saveIntent","saveAttempt","saveSuccess","saveFailure","timing","page_id","page_title","page_ns","user_id","getId","user_class","user_editcount","mw_version","platform","integration","page_token","getPageviewToken","session_token","version","anonymous_user_token","bucket","trackSubscribe","topic","timeStamp","actionPrefix","Math","round","event","ready","warn","abort_type","computeDuration","is_oversample","inSample","console"],"mappings":"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","file":"mobile.editor.overlay.js","sourcesContent":["var Button = require( '../mobile.startup/Button' ),\n\tutil = require( '../mobile.startup/util' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tOverlay = require( '../mobile.startup/Overlay' );\n\n/**\n * Overlay that shows a message about abuse.\n * This overlay is rendered when the error code from the API\n * is related to the abusefilter extension.\n * @class AbuseFilterOverlay\n * @extends Overlay\n * @param {Object} props\n */\nfunction AbuseFilterOverlay( props ) {\n\tOverlay.call( this,\n\t\tutil.extend( {\n\t\t\tclassName: 'overlay abusefilter-overlay'\n\t\t}, props )\n\t);\n}\n\nmfExtend( AbuseFilterOverlay, Overlay, {\n\t/**\n\t * @memberof AbuseFilterOverlay\n\t * @instance\n\t * @mixes Overlay#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {Object} defaults.confirmButton options for a confirm Button\n\t */\n\tdefaults: util.extend( {}, Overlay.prototype.defaults, {\n\t\tconfirmButton: new Button( {\n\t\t\tadditionalClassNames: 'cancel',\n\t\t\tprogressive: true\n\t\t} )\n\t} ),\n\t/**\n\t * @memberof AbuseFilterOverlay\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, Overlay.prototype.templatePartials, {\n\t\tcontent: util.template( `\n<div class=\"content\">\n\t{{{message}}}\n</div>\n\t\t` )\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof AbuseFilterOverlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tOverlay.prototype.postRender.apply( this );\n\t\t// make links open in separate tabs\n\t\tthis.$el.find( 'a' ).attr( 'target', '_blank' );\n\t\tthis.$el.find( '.content' ).append( this.options.confirmButton.$el );\n\t}\n} );\n\nmodule.exports = AbuseFilterOverlay;\n","var util = require( '../mobile.startup/util' ),\n\tView = require( '../mobile.startup/View' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tAbuseFilterOverlay = require( './AbuseFilterOverlay' );\n\n/**\n * Panel that shows an error message related to the abusefilter extension.\n * @class AbuseFilterPanel\n * @extends View\n * @uses AbuseFilterOverlay\n *\n * @param {Object} options Configuration options\n * FIXME: should extend Panel not View. Or the name should be changed to something meaningful.\n */\nfunction AbuseFilterPanel( options ) {\n\tthis.isDisallowed = false;\n\tthis.overlayManager = options.overlayManager;\n\tView.call( this,\n\t\tutil.extend( {\n\t\t\tclassName: 'panel hidden'\n\t\t}, options )\n\t);\n}\n\nmfExtend( AbuseFilterPanel, View, {\n\t/**\n\t * @memberof AbuseFilterPanel\n\t * @instance\n\t * @mixes View#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {string} defaults.readMoreMsg A caption for the button\n\t * allowing the user to read more about the problems with their edit.\n\t * @property {OverlayManager} defaults.overlayManager instance\n\t */\n\tdefaults: {\n\t\treadMoreMsg: mw.msg( 'mobile-frontend-editor-abusefilter-read-more' )\n\t},\n\t/**\n\t * @memberof AbuseFilterPanel\n\t * @instance\n\t */\n\ttemplate: util.template( `\n<div class=\"message\">\n\t<p></p><a href=\"#/abusefilter\" class=\"readmore\">{{readMoreMsg}}</a>\n</div>\n\t` ),\n\t/**\n\t * Show the panel. Create a route to show AbuseFilterOverlay with message.\n\t * @memberof AbuseFilterPanel\n\t * @instance\n\t * @param {string} type The type of alert, e.g. 'warning' or 'disallow'\n\t * @param {string} message Message to show in the AbuseFilter overlay\n\t */\n\tshow: function ( type, message ) {\n\t\tvar msg;\n\n\t\t// OverlayManager will replace previous instance of the route if present\n\t\tthis.overlayManager.add( /^\\/abusefilter$/, function () {\n\t\t\treturn new AbuseFilterOverlay( {\n\t\t\t\tmessage: message\n\t\t\t} );\n\t\t} );\n\n\t\tif ( type === 'warning' ) {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-abusefilter-warning' );\n\t\t} else if ( type === 'disallow' ) {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-abusefilter-disallow' );\n\t\t\tthis.isDisallowed = true;\n\t\t}\n\n\t\tthis.$el.find( '.message p' ).text( msg );\n\t\tthis.$el.removeClass( 'hidden' );\n\t},\n\n\t/**\n\t * Hide the panel.\n\t * @memberof AbuseFilterPanel\n\t * @instance\n\t */\n\thide: function () {\n\t\tthis.$el.addClass( 'hidden' );\n\t}\n} );\n\nmodule.exports = AbuseFilterPanel;\n","'use strict';\nvar Button = require( '../mobile.startup/Button' ),\n\tView = require( '../mobile.startup/View' ),\n\tIcon = require( '../mobile.startup/Icon' ),\n\tuserIcon = new Icon( {\n\t\ttagName: 'span',\n\t\tname: 'profile'\n\t} ),\n\tokButton = new Button( {\n\t\tlabel: mw.msg( 'ok' ),\n\t\ttagName: 'button',\n\t\tprogressive: true,\n\t\tadditionalClassNames: 'cancel'\n\t} ),\n\tutil = require( '../mobile.startup/util' );\n\n/**\n * @extends View\n */\nclass BlockMessageDetails extends View {\n\t/** @inheritdoc */\n\tget isTemplateMode() {\n\t\treturn true;\n\t}\n\t/**\n\t * @inheritdoc\n\t */\n\tget defaults() {\n\t\treturn {\n\t\t\tcreateDetailsAnchorHref: function () {\n\t\t\t\treturn mw.util.getUrl( 'Special:BlockList', { wpTarget: '#' + this.blockId } );\n\t\t\t},\n\t\t\tcreateDetailsAnchorLabel: function () {\n\t\t\t\treturn mw.msg( 'mobile-frontend-editor-blocked-drawer-help' );\n\t\t\t},\n\t\t\tcreateTitle: function () {\n\t\t\t\treturn this.partial ? mw.msg( 'mobile-frontend-editor-blocked-drawer-title-partial' ) : mw.msg( 'mobile-frontend-editor-blocked-drawer-title' );\n\t\t\t},\n\t\t\treasonHeader: mw.msg( 'mobile-frontend-editor-blocked-drawer-reason-header' ),\n\t\t\tcreatorHeader: function () {\n\t\t\t\t// The gender is the subject (the blockee) not the object (the blocker).\n\t\t\t\treturn mw.msg( 'mobile-frontend-editor-blocked-drawer-creator-header',\n\t\t\t\t\tmw.user.options.get( 'gender' ) );\n\t\t\t},\n\t\t\texpiryHeader: mw.msg( 'mobile-frontend-editor-blocked-drawer-expiry-header' )\n\t\t};\n\t}\n\t/**\n\t * @inheritdoc\n\t */\n\tpostRender() {\n\t\tthis.$el.find( '.block-message-creator a' ).prepend(\n\t\t\tuserIcon.$el\n\t\t);\n\t\tthis.$el.find( '.block-message-buttons' ).prepend(\n\t\t\tokButton.$el\n\t\t);\n\t}\n\t/**\n\t * @inheritdoc\n\t */\n\tget template() {\n\t\treturn util.template( `\n<div class=\"block-message\">\n  <div class=\"block-message-icon\"></div>\n  <div class=\"block-message-info\">\n    <div class=\"block-message-item block-message-title\">\n      <h5>{{ createTitle }}</h5>\n    </div>\n    <div class=\"block-message-data\">\n      {{#reason}}\n        <div class=\"block-message-item\">\n          <h6>{{ reasonHeader }}</h6>\n          <div><strong>{{{ reason }}}</strong></div>\n        </div>\n      {{/reason}}\n      <div class=\"block-message-item block-message-creator\">\n        <h6>{{ creatorHeader }}</h6>\n        <div><strong><a href=\"{{ creator.url }}\">{{ creator.name }}</a></strong></div>\n      </div>\n      {{#expiry}}\n        <div class=\"block-message-item\">\n          <h6>{{ expiryHeader }}</h6>\n          <div><strong>{{#duration}}{{ duration }} / {{/duration}}{{ expiry }}</strong></div>\n        </div>\n      {{/expiry}}\n    </div>\n    <div class=\"block-message-item block-message-buttons\">\n      <a href=\"{{ createDetailsAnchorHref }}\">{{ createDetailsAnchorLabel }}</a>\n    </div>\n  </div>` );\n\t}\n}\n\nmodule.exports = BlockMessageDetails;\n","var util = require( '../mobile.startup/util' ),\n\tparseSaveError = require( './parseSaveError' ),\n\tactionParams = require( '../mobile.startup/actionParams' );\n\n/**\n * API that helps save and retrieve page content\n * @class EditorGateway\n *\n * @param {Object} options Configuration options\n * @param {mw.Api} options.api an Api to use.\n * @param {string} options.title the title to edit\n * @param {number} options.sectionId the id of the section to operate edits on.\n * @param {number} [options.oldId] revision to operate on. If absent defaults to latest.\n * @param {boolean} [options.isNewPage] whether the page being created is new\n * @param {boolean} [options.fromModified] whether the page was loaded in a modified state\n */\nfunction EditorGateway( options ) {\n\tthis.api = options.api;\n\tthis.title = options.title;\n\tthis.sectionId = options.sectionId;\n\tthis.oldId = options.oldId;\n\t// return an empty section for new pages\n\tthis.content = options.isNewPage ? '' : undefined;\n\tthis.fromModified = options.fromModified;\n\tthis.hasChanged = options.fromModified;\n}\n\nEditorGateway.prototype = {\n\n\t/**\n\t * Get the block (if there is one) from the result.\n\t * @memberof EditorGateway\n\t * @param {Object} pageObj Page object\n\t * @return {Object|null}\n\t */\n\tgetBlockInfo: function ( pageObj ) {\n\t\tvar blockedError;\n\n\t\tif ( pageObj.actions &&\n\t\t\tpageObj.actions.edit &&\n\t\t\tArray.isArray( pageObj.actions.edit )\n\t\t) {\n\t\t\tpageObj.actions.edit.some( function ( error ) {\n\t\t\t\tif ( [ 'blocked', 'autoblocked' ].indexOf( error.code ) !== -1 ) {\n\t\t\t\t\tblockedError = error;\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t} );\n\n\t\t\tif ( blockedError && blockedError.data && blockedError.data.blockinfo ) {\n\t\t\t\t// Preload library used by EditorOverlayBase#parseBlockInfo\n\t\t\t\t// to format block expiry datetime and duration\n\t\t\t\tmw.loader.load( 'moment' );\n\n\t\t\t\treturn blockedError.data.blockinfo;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t},\n\t/**\n\t * Get the content of a page.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @return {jQuery.Promise}\n\t */\n\tgetContent: function () {\n\t\tvar options,\n\t\t\tself = this;\n\n\t\tfunction resolve() {\n\t\t\treturn util.Deferred().resolve( {\n\t\t\t\ttext: self.content || '',\n\t\t\t\tblockinfo: self.blockinfo\n\t\t\t} );\n\t\t}\n\n\t\tif ( this.content !== undefined ) {\n\t\t\treturn resolve();\n\t\t} else {\n\t\t\toptions = actionParams( {\n\t\t\t\tprop: [ 'revisions', 'info' ],\n\t\t\t\trvprop: [ 'content', 'timestamp' ],\n\t\t\t\ttitles: self.title,\n\t\t\t\t// get block information for this user\n\t\t\t\tintestactions: 'edit',\n\t\t\t\tintestactionsdetail: 'full'\n\t\t\t} );\n\t\t\t// Load text of old revision if desired\n\t\t\tif ( this.oldId ) {\n\t\t\t\toptions.rvstartid = this.oldId;\n\t\t\t}\n\t\t\t// See Bug 50136 - passing rvsection will fail with non wikitext\n\t\t\tif ( util.isNumeric( this.sectionId ) ) {\n\t\t\t\toptions.rvsection = this.sectionId;\n\t\t\t}\n\t\t\treturn this.api.get( options ).then( function ( resp ) {\n\t\t\t\tvar revision, pageObj;\n\n\t\t\t\tif ( resp.error ) {\n\t\t\t\t\treturn util.Deferred().reject( resp.error.code );\n\t\t\t\t}\n\n\t\t\t\tpageObj = resp.query.pages[0];\n\t\t\t\t// page might not exist and caller might not have known.\n\t\t\t\tif ( pageObj.missing !== undefined ) {\n\t\t\t\t\tself.content = '';\n\t\t\t\t} else {\n\t\t\t\t\trevision = pageObj.revisions[0];\n\t\t\t\t\tself.content = revision.content;\n\t\t\t\t\tself.timestamp = revision.timestamp;\n\t\t\t\t}\n\n\t\t\t\t// save content a second time to be able to check for changes\n\t\t\t\tself.originalContent = self.content;\n\t\t\t\tself.blockinfo = self.getBlockInfo( pageObj );\n\n\t\t\t\treturn resolve();\n\t\t\t} );\n\t\t}\n\t},\n\n\t/**\n\t * Mark content as modified and set changes to be submitted when #save\n\t * is invoked.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @param {string} content New section content.\n\t */\n\tsetContent: function ( content ) {\n\t\tif ( this.originalContent !== content || this.fromModified ) {\n\t\t\tthis.hasChanged = true;\n\t\t} else {\n\t\t\tthis.hasChanged = false;\n\t\t}\n\t\tthis.content = content;\n\t},\n\n\t/**\n\t * Mark content as modified and set text that should be prepended to given\n\t * section when #save is invoked.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @param {string} text Text to be prepended.\n\t */\n\tsetPrependText: function ( text ) {\n\t\tthis.prependtext = text;\n\t\tthis.hasChanged = true;\n\t},\n\n\t/**\n\t * Save the new content of the section, previously set using #setContent.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @param {Object} options Configuration options\n\t * @param {string} [options.summary] Optional summary for the edit.\n\t * @param {string} [options.captchaId] If CAPTCHA was requested, ID of the\n\t * captcha.\n\t * @param {string} [options.captchaWord] If CAPTCHA was requested, term\n\t * displayed in the CAPTCHA.\n\t * @return {jQuery.Deferred} On failure callback is passed an object with\n\t * `type` and `details` properties. `type` is a string describing the type\n\t * of error, `details` can be any object (usually error message).\n\t */\n\tsave: function ( options ) {\n\t\tvar self = this,\n\t\t\tresult = util.Deferred();\n\n\t\toptions = options || {};\n\n\t\t/**\n\t\t * Save content. Make an API request.\n\t\t * @return {jQuery.Deferred}\n\t\t */\n\t\tfunction saveContent() {\n\t\t\tvar apiOptions = {\n\t\t\t\taction: 'edit',\n\t\t\t\ttitle: self.title,\n\t\t\t\tsummary: options.summary,\n\t\t\t\tcaptchaid: options.captchaId,\n\t\t\t\tcaptchaword: options.captchaWord,\n\t\t\t\tbasetimestamp: self.timestamp,\n\t\t\t\tstarttimestamp: self.timestamp\n\t\t\t};\n\n\t\t\tif ( self.content !== undefined ) {\n\t\t\t\tapiOptions.text = self.content;\n\t\t\t} else if ( self.prependtext ) {\n\t\t\t\tapiOptions.prependtext = self.prependtext;\n\t\t\t}\n\n\t\t\tif ( util.isNumeric( self.sectionId ) ) {\n\t\t\t\tapiOptions.section = self.sectionId;\n\t\t\t}\n\n\t\t\tself.api.postWithToken( 'csrf', apiOptions ).then( function ( data ) {\n\t\t\t\tif ( data && data.edit && data.edit.result === 'Success' ) {\n\t\t\t\t\tself.hasChanged = false;\n\t\t\t\t\tresult.resolve( data.edit.newrevid );\n\t\t\t\t} else {\n\t\t\t\t\tresult.reject( parseSaveError( data ) );\n\t\t\t\t}\n\t\t\t}, function ( code, data ) {\n\t\t\t\tresult.reject( parseSaveError( data, code || 'unknown' ) );\n\t\t\t} );\n\t\t\treturn result;\n\t\t}\n\n\t\treturn saveContent();\n\t},\n\n\t/**\n\t * Abort any pending previews.\n\t * @memberof EditorGateway\n\t * @instance\n\t */\n\tabortPreview: function () {\n\t\tif ( this._pending ) {\n\t\t\tthis._pending.abort();\n\t\t}\n\t},\n\n\t/**\n\t * Get page preview from the API and abort any existing previews.\n\t * @memberof EditorGateway\n\t * @instance\n\t * @param {Object} options API query parameters\n\t * @return {jQuery.Deferred}\n\t */\n\tgetPreview: function ( options ) {\n\t\tvar result = util.Deferred(),\n\t\t\tsectionLine = '',\n\t\t\tsectionId = '',\n\t\t\trequest,\n\t\t\tself = this;\n\n\t\tutil.extend( options, {\n\t\t\taction: 'parse',\n\t\t\t// Enable section preview mode to avoid errors (bug 49218)\n\t\t\tsectionpreview: true,\n\t\t\t// Hide section edit links\n\t\t\tdisableeditsection: true,\n\t\t\t// needed for pre-save transform to work (bug 53692)\n\t\t\tpst: true,\n\t\t\t// Output mobile HTML (bug 54243)\n\t\t\tmobileformat: true,\n\t\t\ttitle: this.title,\n\t\t\tprop: [ 'text', 'sections' ]\n\t\t} );\n\n\t\tthis.abortPreview();\n\n\t\trequest = this.api.post( options );\n\t\tthis._pending = request.then( function ( resp ) {\n\t\t\tif ( resp && resp.parse && resp.parse.text ) {\n\t\t\t\t// section 0 haven't a section name so skip\n\t\t\t\tif ( self.sectionId !== 0 &&\n\t\t\t\t\tresp.parse.sections !== undefined &&\n\t\t\t\t\tresp.parse.sections[0] !== undefined\n\t\t\t\t) {\n\t\t\t\t\tif ( resp.parse.sections[0].anchor !== undefined ) {\n\t\t\t\t\t\tsectionId = resp.parse.sections[0].anchor;\n\t\t\t\t\t}\n\t\t\t\t\tif ( resp.parse.sections[0].line !== undefined ) {\n\t\t\t\t\t\tsectionLine = resp.parse.sections[0].line;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tresult.resolve( {\n\t\t\t\t\ttext: resp.parse.text['*'],\n\t\t\t\t\tid: sectionId,\n\t\t\t\t\tline: sectionLine\n\t\t\t\t} );\n\t\t\t} else {\n\t\t\t\tresult.reject();\n\t\t\t}\n\t\t}, function () {\n\t\t\tresult.reject();\n\t\t} ).promise( {\n\t\t\tabort: function () { request.abort(); }\n\t\t} );\n\n\t\treturn result;\n\t}\n};\n\nmodule.exports = EditorGateway;\n","/* global $ */\nvar Overlay = require( '../mobile.startup/Overlay' ),\n\tutil = require( '../mobile.startup/util' ),\n\theaders = require( '../mobile.startup/headers' ),\n\tPageGateway = require( '../mobile.startup/PageGateway' ),\n\ticons = require( '../mobile.startup/icons' ),\n\tButton = require( '../mobile.startup/Button' ),\n\ttoast = require( '../mobile.startup/toast' ),\n\tsaveFailureMessage = require( './saveFailureMessage' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tMessageBox = require( '../mobile.startup/MessageBox' ),\n\tmwUser = mw.user;\n\n/**\n * 'Edit' button\n * @param {OO.ui.ToolGroup} toolGroup\n * @param {Object} config\n */\nfunction EditVeTool( toolGroup, config ) {\n\tconfig = config || {};\n\tconfig.classes = [ 'visual-editor' ];\n\tEditVeTool.super.call( this, toolGroup, config );\n}\nOO.inheritClass( EditVeTool, OO.ui.Tool );\n\nEditVeTool.static.name = 'editVe';\nEditVeTool.static.icon = 'edit';\nEditVeTool.static.group = 'editorSwitcher';\nEditVeTool.static.title = mw.msg( 'mobile-frontend-editor-switch-visual-editor' );\n/**\n * click handler\n * @memberof EditVeTool\n * @instance\n */\nEditVeTool.prototype.onSelect = function () {\n\t// will be overridden later\n};\n/**\n * Toolbar update state handler.\n * @memberof EditVeTool\n * @instance\n */\nEditVeTool.prototype.onUpdateState = function () {\n\t// do nothing\n};\n\n/**\n * Base class for SourceEditorOverlay and VisualEditorOverlay\n * @class EditorOverlayBase\n * @extends Overlay\n * @uses Icon\n * @uses user\n * @param {Object} params Configuration options\n * @param {number|null} params.editCount of user\n * @param {boolean} params.editSwitcher whether possible to switch mode in header\n * @param {boolean} params.hasToolbar whether the editor has a toolbar\n */\nfunction EditorOverlayBase( params ) {\n\tvar\n\t\toptions = util.extend(\n\t\t\ttrue,\n\t\t\t{\n\t\t\t\tonBeforeExit: this.onBeforeExit.bind( this ),\n\t\t\t\tclassName: 'overlay editor-overlay',\n\t\t\t\tisBorderBox: false\n\t\t\t},\n\t\t\tparams,\n\t\t\t{\n\t\t\t\tevents: util.extend(\n\t\t\t\t\t{\n\t\t\t\t\t\t'click .back': 'onClickBack',\n\t\t\t\t\t\t'click .continue': 'onClickContinue',\n\t\t\t\t\t\t'click .submit': 'onClickSubmit',\n\t\t\t\t\t\t'click .anonymous': 'onClickAnonymous'\n\t\t\t\t\t},\n\t\t\t\t\tparams.events\n\t\t\t\t)\n\t\t\t}\n\t\t);\n\n\tif ( options.isNewPage ) {\n\t\toptions.placeholder = mw.msg( 'mobile-frontend-editor-placeholder-new-page', mwUser );\n\t}\n\t// change the message to request a summary when not in article namespace\n\tif ( mw.config.get( 'wgNamespaceNumber' ) !== 0 ) {\n\t\toptions.summaryRequestMsg = mw.msg( 'mobile-frontend-editor-summary' );\n\t}\n\tthis.pageGateway = new PageGateway( options.api );\n\tthis.editCount = options.editCount;\n\tthis.isNewPage = options.isNewPage;\n\tthis.isNewEditor = options.editCount === 0;\n\tthis.sectionId = options.sectionId;\n\t// FIXME: Pass this in via options rather than accessing mw.config\n\tthis.config = mw.config.get( 'wgMFEditorOptions' );\n\tthis.sessionId = options.sessionId;\n\tthis.overlayManager = options.overlayManager;\n\n\tOverlay.call( this, options );\n}\n\nmfExtend( EditorOverlayBase, Overlay, {\n\t/**\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @mixes Overlay#defaults\n\t * @property {Object} defaults Default options hash.\n\t * @property {OverlayManager} defaults.overlayManager instance\n\t * @property {mw.Api} defaults.api to interact with\n\t * @property {boolean} defaults.hasToolbar Whether the editor has a toolbar or not. When\n\t *  disabled a header will be show instead.\n\t * @property {string} defaults.continueMsg Caption for the next button on edit form\n\t * which takes you to the screen that shows a preview and license information.\n\t * @property {string} defaults.closeMsg Caption for a button that takes you back to editing\n\t * from edit preview screen.\n\t * @property {string} defaults.summaryRequestMsg Header above edit summary input field\n\t * asking the user to summarize the changes they made to the page.\n\t * @property {string} defaults.summaryMsg A placeholder with examples for the summary input\n\t * field asking user what they changed.\n\t * @property {string} defaults.placeholder Placeholder text for empty sections.\n\t * @property {string} defaults.captchaMsg Placeholder for captcha input field.\n\t * @property {string} defaults.captchaTryAgainMsg A message shown when user enters\n\t * wrong CAPTCHA and a new one is displayed.\n\t * @property {string} defaults.switchMsg Label for button that allows the user\n\t * to switch between two different editing interfaces.\n\t * @property {string} defaults.licenseMsg Text and link of the license,\n\t * under which this contribution will be released to inform the user.\n\t */\n\tdefaults: util.extend( {}, Overlay.prototype.defaults, {\n\t\thasToolbar: false,\n\t\tcontinueMsg: mw.msg( 'mobile-frontend-editor-continue' ),\n\t\tcloseMsg: mw.msg( 'mobile-frontend-editor-keep-editing' ),\n\t\tsummaryRequestMsg: mw.msg( 'mobile-frontend-editor-summary-request' ),\n\t\tsummaryMsg: mw.msg( 'mobile-frontend-editor-summary-placeholder' ),\n\t\tplaceholder: mw.msg( 'mobile-frontend-editor-placeholder' ),\n\t\tcaptchaMsg: mw.msg( 'mobile-frontend-account-create-captcha-placeholder' ),\n\t\tcaptchaTryAgainMsg: mw.msg( 'mobile-frontend-editor-captcha-try-again' ),\n\t\tswitchMsg: mw.msg( 'mobile-frontend-editor-switch-editor' ),\n\t\tconfirmMsg: mw.msg( 'mobile-frontend-editor-cancel-confirm' ),\n\t\tlicenseMsg: undefined\n\t} ),\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\ttemplate: util.template( `\n<div class=\"overlay-header-container header-container position-fixed\"></div>\n\n<div class=\"overlay-content\">\n\t<div class=\"panels\">\n\t\t<div class=\"save-panel panel hideable hidden\">\n\t\t\t<div id=\"error-notice-container\"></div>\n\t\t\t<p class=\"summary-request\">{{{summaryRequestMsg}}}</p>\n\t\t\t<textarea rows=\"2\" class=\"mw-ui-input summary\" placeholder=\"{{summaryMsg}}\"></textarea>\n\t\t\t{{#licenseMsg}}<p class=\"license\">{{{licenseMsg}}}</p>{{/licenseMsg}}\n\t\t</div>\n\t\t<div class=\"captcha-panel panel hideable hidden\">\n\t\t\t<div class=\"captcha-box\">\n\t\t\t\t<img id=\"image\" src=\"\">\n\t\t\t\t<div id=\"question\"></div>\n\t\t\t\t<input class=\"captcha-word mw-ui-input\" placeholder=\"{{captchaMsg}}\" />\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t{{>content}}\n</div>\n<div class=\"overlay-footer-container position-fixed\">\n\t{{>footer}}\n</div>\n\t` ),\n\t/**\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tsectionId: '',\n\t/**\n\t * Logs an event to http://meta.wikimedia.org/wiki/Schema:EditAttemptStep\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Object} data\n\t */\n\tlog: function ( data ) {\n\t\tmw.track( 'mf.schemaEditAttemptStep', util.extend( data, {\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\teditor_interface: this.editor,\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\tediting_session_id: this.sessionId\n\t\t} ) );\n\t},\n\t/**\n\t * Logs an event to http://meta.wikimedia.org/wiki/Schema:VisualEditorFeatureUse\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Object} data\n\t */\n\tlogFeatureUse: function ( data ) {\n\t\tmw.track( 'mf.schemaVisualEditorFeatureUse', util.extend( data, {\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\tediting_session_id: this.sessionId\n\t\t} ) );\n\t},\n\n\t/**\n\t * If this is a new article, require confirmation before saving.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @return {boolean} The user confirmed saving\n\t */\n\tconfirmSave: function () {\n\t\tif ( this.isNewPage &&\n\t\t\t// TODO: Replace with an OOUI dialog\n\t\t\t!window.confirm( mw.msg( 'mobile-frontend-editor-new-page-confirm', mwUser ) )\n\t\t) {\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t},\n\t/**\n\t * Executed when page save is complete. Handles reloading the page, showing toast\n\t * messages.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {number} newRevId ID of the newly created revision\n\t */\n\tonSaveComplete: function ( newRevId ) {\n\t\tvar msg,\n\t\t\t$window = util.getWindow(),\n\t\t\ttitle = this.options.title,\n\t\t\tself = this;\n\n\t\tthis.saved = true;\n\n\t\t// FIXME: use generic method for following 3 lines\n\t\tthis.pageGateway.invalidatePage( title );\n\n\t\tif ( this.isNewPage ) {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-success-new-page' );\n\t\t} else if ( this.isNewEditor ) {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-success-landmark-1' );\n\t\t} else {\n\t\t\tmsg = mw.msg( 'mobile-frontend-editor-success' );\n\t\t}\n\t\ttoast.showOnPageReload( msg, { type: 'success' } );\n\n\t\t// Ensure we don't lose this event when logging\n\t\tthis.log( {\n\t\t\taction: 'saveSuccess',\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\trevision_id: newRevId\n\t\t} );\n\t\tif ( self.sectionId ) {\n\t\t\t// Ideally we'd want to do this via replaceState (see T189173)\n\t\t\t// eslint-disable-next-line no-restricted-properties\n\t\t\twindow.location.hash = '#' + self.sectionId;\n\t\t} else {\n\t\t\t// Cancel the hash fragment\n\t\t\t// otherwise clicking back after a save will take you back to the editor.\n\t\t\t// We avoid calling the hide method of the overlay here as this can be asynchronous\n\t\t\t// and may conflict with the window.reload call below.\n\t\t\t// eslint-disable-next-line no-restricted-properties\n\t\t\twindow.location.hash = '#';\n\t\t}\n\n\t\t$window.off( 'beforeunload.mfeditorwarning' );\n\n\t\t// Note the \"#\" may be in the URL.\n\t\t// If so, using window.location alone will not reload the page\n\t\t// we need to forcefully refresh\n\t\t// eslint-disable-next-line no-restricted-properties\n\t\twindow.location.reload();\n\t},\n\t/**\n\t * Executed when page save fails. Handles logging the error. Subclasses\n\t * should display error messages as appropriate.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Object} data Details about the failure, from EditorGateway.parseSaveError\n\t */\n\tonSaveFailure: function ( data ) {\n\t\tvar key = data && data.details && data.details.code,\n\t\t\ttypeMap = {\n\t\t\t\teditconflict: 'editConflict',\n\t\t\t\twasdeleted: 'editPageDeleted',\n\t\t\t\t'abusefilter-disallowed': 'extensionAbuseFilter',\n\t\t\t\tcaptcha: 'extensionCaptcha',\n\t\t\t\tspamprotectiontext: 'extensionSpamBlacklist',\n\t\t\t\t'titleblacklist-forbidden-edit': 'extensionTitleBlacklist'\n\t\t\t};\n\n\t\tif ( data.type === 'captcha' ) {\n\t\t\tkey = 'captcha';\n\t\t}\n\n\t\tthis.log( {\n\t\t\taction: 'saveFailure',\n\t\t\tmessage: saveFailureMessage( data ),\n\t\t\ttype: typeMap[key] || 'responseUnknown'\n\t\t} );\n\t},\n\t/**\n\t * Report load errors back to the user. Silently record the error using EventLogging.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {string} text Text of message to display to user\n\t * @param {string} heading heading text to display to user\n\t */\n\treportError: function ( text, heading ) {\n\t\tvar errorNotice = new MessageBox( {\n\t\t\tclassName: 'errorbox',\n\t\t\tmsg: text,\n\t\t\theading: heading\n\t\t} );\n\t\tthis.$errorNoticeContainer.html( errorNotice.$el );\n\t},\n\thideErrorNotice: function () {\n\t\tthis.$errorNoticeContainer.empty();\n\t},\n\t/**\n\t * Prepares the penultimate screen before saving.\n\t * Expects to be overridden by child class.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonStageChanges: function () {\n\t\tthis.showHidden( '.save-header, .save-panel' );\n\t\tthis.log( {\n\t\t\taction: 'saveIntent'\n\t\t} );\n\t\t// Scroll to the top of the page, so that the summary input is visible\n\t\t// (even if overlay was scrolled down when editing) and weird iOS header\n\t\t// problems are avoided (header position not updating to the top of the\n\t\t// screen, instead staying lower until a subsequent scroll event).\n\t\twindow.scrollTo( 0, 1 );\n\t},\n\t/**\n\t * Executed when the editor clicks the save button. Expects to be overridden by child\n\t * class. Checks if the save needs to be confirmed.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonSaveBegin: function () {\n\t\tthis.confirmAborted = false;\n\t\tthis.hideErrorNotice();\n\t\t// Ask for confirmation in some cases\n\t\tif ( !this.confirmSave() ) {\n\t\t\tthis.confirmAborted = true;\n\t\t\treturn;\n\t\t}\n\t\tthis.log( {\n\t\t\taction: 'saveAttempt'\n\t\t} );\n\t},\n\t/**\n\t * @inheritdoc\n\t */\n\tpreRender: function () {\n\t\tconst options = this.options;\n\n\t\tthis.options.headers = [\n\t\t\theaders.formHeader(\n\t\t\t\tutil.template( `\n{{^hasToolbar}}\n<div class=\"overlay-title\">\n\t<h2>{{{editingMsg}}}</h2>\n</div>\n{{/hasToolbar}}\n{{#hasToolbar}}<div class=\"toolbar\"></div>{{/hasToolbar}}\n{{#editSwitcher}}\n\t<div class=\"switcher-container\">\n\t</div>\n{{/editSwitcher}}\n\t\t\t\t` ).render( {\n\t\t\t\t\thasToolbar: options.hasToolbar,\n\t\t\t\t\teditSwitcher: options.editSwitcher,\n\t\t\t\t\teditingMsg: options.editingMsg\n\t\t\t\t} ),\n\t\t\t\toptions.readOnly ? [] : [\n\t\t\t\t\tnew Button( {\n\t\t\t\t\t\ttagName: 'button',\n\t\t\t\t\t\tadditionalClassNames: 'continue',\n\t\t\t\t\t\tdisabled: true,\n\t\t\t\t\t\tlabel: this.config.skipPreview ?\n\t\t\t\t\t\t\tutil.saveButtonMessage() :\n\t\t\t\t\t\t\toptions.continueMsg\n\t\t\t\t\t} )\n\t\t\t\t],\n\t\t\t\ticons.cancel(),\n\t\t\t\t'initial-header'\n\t\t\t),\n\t\t\theaders.saveHeader( options.previewingMsg, 'save-header hidden' ),\n\t\t\theaders.savingHeader( mw.msg( 'mobile-frontend-editor-wait' ) )\n\t\t];\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\t// decide what happens, when the user clicks the continue button\n\t\tif ( this.config.skipPreview ) {\n\t\t\t// skip the preview and save the changes\n\t\t\tthis.nextStep = 'onSaveBegin';\n\t\t} else {\n\t\t\t// default: show the preview step\n\t\t\tthis.nextStep = 'onStageChanges';\n\t\t}\n\t\tthis.$errorNoticeContainer = this.$el.find( '#error-notice-container' );\n\n\t\tthis.$el.find( '.overlay-content' ).append( icons.spinner().$el );\n\t\tOverlay.prototype.postRender.apply( this );\n\n\t\tthis.showHidden( '.initial-header' );\n\t},\n\tshow: function () {\n\t\tvar self = this;\n\t\tthis.allowCloseWindow = mw.confirmCloseWindow( {\n\t\t\t// Returns true if content has changed\n\t\t\ttest: function () {\n\t\t\t\t// Check if content has changed\n\t\t\t\treturn self.hasChanged();\n\t\t\t},\n\n\t\t\t// Message to show the user, if content has changed\n\t\t\tmessage: mw.msg( 'mobile-frontend-editor-cancel-confirm' ),\n\t\t\t// Event namespace\n\t\t\tnamespace: 'editwarning'\n\t\t} );\n\n\t\tthis.saved = false;\n\t\tOverlay.prototype.show.call( this );\n\n\t\t// Inform other interested code that the editor has loaded\n\t\tmw.hook( 'mobileFrontend.editorOpened' ).fire( this.editor );\n\t},\n\t/**\n\t * Back button click handler\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonClickBack: function () {},\n\t/**\n\t * Submit button click handler\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonClickSubmit: function () {\n\t\tthis.onSaveBegin();\n\t},\n\t/**\n\t * Continue button click handler\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonClickContinue: function () {\n\t\tthis[this.nextStep]();\n\t},\n\t/**\n\t * \"Edit without logging in\" button click handler\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\tonClickAnonymous: function () {},\n\t/**\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Function} exit Callback to exit the overlay\n\t */\n\tonBeforeExit: function ( exit ) {\n\t\tvar windowManager,\n\t\t\tself = this;\n\t\tif ( this.hasChanged() && !this.switching ) {\n\t\t\twindowManager = OO.ui.getWindowManager();\n\t\t\twindowManager.addWindows( [ new mw.widgets.AbandonEditDialog() ] );\n\t\t\twindowManager.openWindow( 'abandonedit' )\n\t\t\t\t.closed.then( function ( data ) {\n\t\t\t\t\tif ( data && data.action === 'discard' ) {\n\t\t\t\t\t\t// log abandonment\n\t\t\t\t\t\tself.log( {\n\t\t\t\t\t\t\taction: 'abort',\n\t\t\t\t\t\t\tmechanism: 'cancel',\n\t\t\t\t\t\t\ttype: 'abandon'\n\t\t\t\t\t\t} );\n\t\t\t\t\t\tself.allowCloseWindow.release();\n\t\t\t\t\t\tmw.hook( 'mobileFrontend.editorClosed' ).fire();\n\t\t\t\t\t\texit();\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\treturn;\n\t\t}\n\t\tif ( !this.switching && !this.saved ) {\n\t\t\t// log leaving without changes\n\t\t\tthis.log( {\n\t\t\t\taction: 'abort',\n\t\t\t\tmechanism: 'cancel',\n\t\t\t\t// if this is VE, hasChanged will be false because the Surface has\n\t\t\t\t// already been destroyed (which is good because it stops us\n\t\t\t\t// double-showing the abandon changes dialog above)... but we can\n\t\t\t\t// test whether there *were* changes for logging purposes by\n\t\t\t\t// examining the target:\n\t\t\t\ttype: ( this.target && this.target.edited ) ? 'abandon' : 'nochange'\n\t\t\t} );\n\t\t}\n\t\tthis.allowCloseWindow.release();\n\t\tmw.hook( 'mobileFrontend.editorClosed' ).fire();\n\t\texit();\n\t},\n\t/**\n\t * Sets additional values used for anonymous editing warning.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Object} options\n\t * @return {jQuery.Element}\n\t */\n\tcreateAnonWarning: function ( options ) {\n\t\tvar $actions = $( '<div>' ).addClass( 'actions' ),\n\t\t\t$anonWarning = $( '<div>' ).addClass( 'anonwarning content' ).append(\n\t\t\t\tnew MessageBox( {\n\t\t\t\t\tclassName: 'warningbox anon-msg',\n\t\t\t\t\tmsg: mw.msg( 'mobile-frontend-editor-anonwarning' )\n\t\t\t\t} ).$el,\n\t\t\t\t$actions\n\t\t\t),\n\t\t\tparams = util.extend( {\n\t\t\t// use wgPageName as this includes the namespace if outside Main\n\t\t\t\treturnto: options.returnTo || mw.config.get( 'wgPageName' ),\n\t\t\t\treturntoquery: 'action=edit&section=' + options.sectionId,\n\t\t\t\twarning: 'mobile-frontend-edit-login-action'\n\t\t\t}, options.queryParams ),\n\t\t\tsignupParams = util.extend( {\n\t\t\t\ttype: 'signup',\n\t\t\t\twarning: 'mobile-frontend-edit-signup-action'\n\t\t\t}, options.signupQueryParams ),\n\t\t\tanonymousEditorActions = [\n\t\t\t\tnew Button( {\n\t\t\t\t\tlabel: mw.msg( 'mobile-frontend-editor-anon' ),\n\t\t\t\t\tblock: true,\n\t\t\t\t\tadditionalClassNames: 'anonymous progressive',\n\t\t\t\t\tprogressive: true\n\t\t\t\t} ),\n\t\t\t\tnew Button( {\n\t\t\t\t\tblock: true,\n\t\t\t\t\thref: mw.util.getUrl( 'Special:UserLogin', params ),\n\t\t\t\t\tlabel: mw.msg( 'mobile-frontend-watchlist-cta-button-login' )\n\t\t\t\t} ),\n\t\t\t\tnew Button( {\n\t\t\t\t\tblock: true,\n\t\t\t\t\thref: mw.util.getUrl( 'Special:UserLogin', util.extend( params, signupParams ) ),\n\t\t\t\t\tlabel: mw.msg( 'mobile-frontend-watchlist-cta-button-signup' )\n\t\t\t\t} )\n\t\t\t];\n\n\t\t$actions.append(\n\t\t\tanonymousEditorActions.map( function ( action ) {\n\t\t\t\treturn action.$el;\n\t\t\t} )\n\t\t);\n\n\t\treturn $anonWarning;\n\t},\n\n\t/**\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {string} blockinfo\n\t * @return {Object}\n\t */\n\tparseBlockInfo: function ( blockinfo ) {\n\t\tvar blockInfo, expiry, reason,\n\t\t\tmoment = window.moment;\n\n\t\t// Workaround to parse a message parameter for mw.message, see T96885\n\t\tfunction jqueryMsgParse( wikitext ) {\n\t\t\tvar parser, ast;\n\t\t\t// eslint-disable-next-line new-cap\n\t\t\tparser = new mw.jqueryMsg.parser();\n\t\t\ttry {\n\t\t\t\tast = parser.wikiTextToAst( wikitext );\n\t\t\t\treturn parser.emitter.emit( ast ).html();\n\t\t\t} catch ( e ) {\n\t\t\t\t// Ignore error as it's probably the parser error. Usually this is because we\n\t\t\t\t// can't parse templates.\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tblockInfo = {\n\t\t\tpartial: blockinfo.blockpartial || false,\n\t\t\tcreator: {\n\t\t\t\tname: blockinfo.blockedby,\n\t\t\t\turl: mw.Title.makeTitle(\n\t\t\t\t\tmw.config.get( 'wgNamespaceIds' ).user,\n\t\t\t\t\tblockinfo.blockedby\n\t\t\t\t).getUrl()\n\t\t\t},\n\t\t\texpiry: null,\n\t\t\tduration: null,\n\t\t\treason: '',\n\t\t\tblockId: blockinfo.blockid\n\t\t};\n\n\t\texpiry = blockinfo.blockexpiry;\n\t\tif ( [ 'infinite', 'indefinite', 'infinity', 'never' ].indexOf( expiry ) === -1 ) {\n\t\t\tblockInfo.expiry = moment( expiry ).format( 'LLL' );\n\t\t\tblockInfo.duration = moment().to( expiry, true );\n\t\t}\n\n\t\treason = blockinfo.blockreason;\n\t\tif ( reason ) {\n\t\t\tblockInfo.reason = jqueryMsgParse( reason ) || mw.html.escape( reason );\n\t\t} else {\n\t\t\tblockInfo.reason = mw.message( 'mobile-frontend-editor-generic-block-reason' ).escaped();\n\t\t}\n\n\t\treturn blockInfo;\n\t},\n\n\t/**\n\t * Get an options object not containing any defaults or editor\n\t * specific options, so that it can be used to construct a\n\t * different editor for switching.\n\t *\n\t * @return {Object} Options\n\t */\n\tgetOptionsForSwitch: function () {\n\t\t// Only preserve options that would be passed in editor.js#setupEditor\n\t\t// and skip over defaults.\n\t\treturn {\n\t\t\tswitched: true,\n\t\t\toverlayManager: this.options.overlayManager,\n\t\t\tcurrentPageHTMLParser: this.options.currentPageHTMLParser,\n\t\t\tfakeScroll: this.options.fakeScroll,\n\t\t\tapi: this.options.api,\n\t\t\tlicenseMsg: this.options.licenseMsg,\n\t\t\ttitle: this.options.title,\n\t\t\ttitleObj: this.options.titleObj,\n\t\t\tisAnon: this.options.isAnon,\n\t\t\tisNewPage: this.options.isNewPage,\n\t\t\teditCount: this.options.editCount,\n\t\t\toldId: this.options.oldId,\n\t\t\tcontentLang: this.options.contentLang,\n\t\t\tcontentDir: this.options.contentDir,\n\t\t\tsessionId: this.options.sessionId,\n\t\t\tsectionId: this.options.sectionId\n\t\t};\n\t},\n\n\t/**\n\t * Checks whether the state of the thing being edited as changed. Expects to be\n\t * implemented by child class.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t */\n\thasChanged: function () {},\n\t/**\n\t * Handles a failed save due to a CAPTCHA provided by ConfirmEdit extension.\n\t * @memberof EditorOverlayBase\n\t * @instance\n\t * @param {Object} details Details returned from the api.\n\t */\n\thandleCaptcha: function ( details ) {\n\t\tvar self = this,\n\t\t\t$input = this.$el.find( '.captcha-word' );\n\n\t\tif ( this.captchaShown ) {\n\t\t\t$input.val( '' );\n\t\t\t$input.attr( 'placeholder', this.options.captchaTryAgainMsg );\n\t\t\tsetTimeout( function () {\n\t\t\t\t$input.attr( 'placeholder', self.options.captchaMsg );\n\t\t\t}, 2000 );\n\t\t}\n\n\t\t// handle different mime types different\n\t\tif ( details.mime.indexOf( 'image/' ) === 0 ) {\n\t\t\t// image based CAPTCHA's like provided by FancyCaptcha, ReCaptcha or similar\n\t\t\tthis.$el.find( '.captcha-panel#question' ).detach();\n\t\t\tthis.$el.find( '.captcha-panel img' ).attr( 'src', details.url );\n\t\t} else {\n\t\t\t// not image based CAPTCHA.\n\t\t\tthis.$el.find( '.captcha-panel #image' ).detach();\n\t\t\tif ( details.mime.indexOf( 'text/html' ) === 0 ) {\n\t\t\t\t// handle mime type of HTML as HTML content (display as-is).\n\t\t\t\t// QuestyCaptcha now have default MIME type \"text/html\": see T147606\n\t\t\t\tthis.$el.find( '.captcha-panel #question' ).html( details.question );\n\t\t\t} else {\n\t\t\t\t// handle mime types\n\t\t\t\t// (other than image based ones and HTML based ones)\n\t\t\t\t// as plain text by default.\n\t\t\t\t// e.g. MathCaptcha (solve a math formula) or\n\t\t\t\t// SimpleCaptcha (simple math formula)\n\t\t\t\tthis.$el.find( '.captcha-panel #question' ).text( details.question );\n\t\t\t}\n\t\t}\n\n\t\tthis.showHidden( '.save-header, .captcha-panel' );\n\t\tthis.captchaShown = true;\n\t}\n} );\n\nmodule.exports = EditorOverlayBase;\n","var EditorOverlayBase = require( './EditorOverlayBase' ),\n\tutil = require( '../mobile.startup/util' ),\n\tSection = require( '../mobile.startup/Section' ),\n\tsaveFailureMessage = require( './saveFailureMessage' ),\n\tEditorGateway = require( './EditorGateway' ),\n\tAbuseFilterPanel = require( './AbuseFilterPanel' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\tblockMessageDrawer = require( './blockMessageDrawer' ),\n\tVisualEditorOverlay = require( './VisualEditorOverlay' );\n\n/**\n * Overlay that shows an editor\n * @class SourceEditorOverlay\n * @uses Section\n * @uses AbuseFilterPanel\n * @uses EditorGateway\n * @uses VisualEditorOverlay\n * @extends EditorOverlayBase\n *\n * @param {Object} options Configuration options\n * @param {jQuery.Promise} [dataPromise] Optional promise for loading content\n */\nfunction SourceEditorOverlay( options, dataPromise ) {\n\tthis.isFirefox = /firefox/i.test( window.navigator.userAgent );\n\tthis.gateway = new EditorGateway( {\n\t\tapi: options.api,\n\t\ttitle: options.title,\n\t\tsectionId: options.sectionId,\n\t\toldId: options.oldId,\n\t\tisNewPage: options.isNewPage,\n\t\tfromModified: !!dataPromise\n\t} );\n\tthis.readOnly = !!options.oldId; // If old revision, readOnly mode\n\tthis.dataPromise = dataPromise;\n\tif ( this.isVisualEditorEnabled() ) {\n\t\toptions.editSwitcher = true;\n\t}\n\tif ( this.readOnly ) {\n\t\toptions.readOnly = true;\n\t\toptions.editingMsg = mw.msg( 'mobile-frontend-editor-viewing-source-page', options.title );\n\t} else {\n\t\toptions.editingMsg = mw.msg( 'mobile-frontend-editor-editing-page', options.title );\n\t}\n\toptions.previewingMsg = mw.msg( 'mobile-frontend-editor-previewing-page', options.title );\n\tEditorOverlayBase.call(\n\t\tthis,\n\t\tutil.extend( true,\n\t\t\t{ events: { 'input .wikitext-editor': 'onInputWikitextEditor' } },\n\t\t\toptions\n\t\t)\n\t);\n}\n\nmfExtend( SourceEditorOverlay, EditorOverlayBase, {\n\t/**\n\t * @inheritdoc\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, EditorOverlayBase.prototype.templatePartials, {\n\t\tcontent: util.template( `\n<div lang=\"{{contentLang}}\" dir=\"{{contentDir}}\" class=\"editor-container\">\n\t<textarea class=\"wikitext-editor\" id=\"wikitext-editor\" cols=\"40\" rows=\"10\" placeholder=\"{{placeholder}}\"></textarea>\n\t<div class=\"preview content\"></div>\n</div>\n\t\t` )\n\t} ),\n\t/**\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\teditor: 'wikitext',\n\t/**\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\tsectionLine: '',\n\n\t/**\n\t * Check whether VisualEditor is enabled or not.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @return {boolean}\n\t */\n\tisVisualEditorEnabled: function () {\n\t\tvar ns = mw.config.get( 'wgVisualEditorConfig' ) &&\n\t\t\tmw.config.get( 'wgVisualEditorConfig' ).namespaces;\n\n\t\treturn ns &&\n\t\t\tns.indexOf(\n\t\t\t\tmw.config.get( 'wgNamespaceNumber' )\n\t\t\t) > -1 &&\n\t\t\tmw.config.get( 'wgTranslatePageTranslation' ) !== 'translation' &&\n\t\t\tmw.config.get( 'wgPageContentModel' ) === 'wikitext';\n\t},\n\t/**\n\t * Wikitext Editor input handler\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\tonInputWikitextEditor: function () {\n\t\tthis.gateway.setContent( this.$el.find( '.wikitext-editor' ).val() );\n\t\tthis.$el.find( '.continue, .submit' ).prop( 'disabled', false );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\tonClickBack: function () {\n\t\tEditorOverlayBase.prototype.onClickBack.apply( this, arguments );\n\t\tthis._hidePreview();\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\tpostRender: function () {\n\t\tvar self = this,\n\t\t\toptions = this.options,\n\t\t\tshowAnonWarning = options.isAnon && !options.switched;\n\n\t\t// log edit attempt\n\t\tthis.log( { action: 'ready' } );\n\t\tthis.log( { action: 'loaded' } );\n\n\t\tif ( this.isVisualEditorEnabled() ) {\n\t\t\tmw.loader.using( 'ext.visualEditor.switching' ).then( function () {\n\t\t\t\tvar switchToolbar, windowManager, switchWindow,\n\t\t\t\t\ttoolFactory = new OO.ui.ToolFactory(),\n\t\t\t\t\ttoolGroupFactory = new OO.ui.ToolGroupFactory();\n\n\t\t\t\ttoolFactory.register( mw.libs.ve.MWEditModeVisualTool );\n\t\t\t\ttoolFactory.register( mw.libs.ve.MWEditModeSourceTool );\n\t\t\t\tswitchToolbar = new OO.ui.Toolbar( toolFactory, toolGroupFactory, {\n\t\t\t\t\tclasses: [ 'editor-switcher' ]\n\t\t\t\t} );\n\n\t\t\t\tswitchToolbar.on( 'switchEditor', function ( mode ) {\n\t\t\t\t\tvar\n\t\t\t\t\t\tconfig = mw.config.get( 'wgVisualEditorConfig' ),\n\t\t\t\t\t\tcanSwitch = config.fullRestbaseUrl || config.allowLossySwitching;\n\t\t\t\t\tif ( mode === 'visual' ) {\n\t\t\t\t\t\tif ( !self.gateway.hasChanged ) {\n\t\t\t\t\t\t\tself._switchToVisualEditor();\n\t\t\t\t\t\t} else if ( canSwitch ) {\n\t\t\t\t\t\t\t// Pass wikitext if there are changes.\n\t\t\t\t\t\t\tself._switchToVisualEditor( self.gateway.content );\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\twindowManager = new OO.ui.WindowManager();\n\t\t\t\t\t\t\tswitchWindow = new mw.libs.ve.SwitchConfirmDialog();\n\t\t\t\t\t\t\twindowManager.$element.appendTo( document.body );\n\t\t\t\t\t\t\twindowManager.addWindows( [ switchWindow ] );\n\t\t\t\t\t\t\twindowManager.openWindow( switchWindow, { mode: 'simple' } )\n\t\t\t\t\t\t\t\t.closed.then( function ( data ) {\n\t\t\t\t\t\t\t\t\tif ( data && data.action === 'discard' ) {\n\t\t\t\t\t\t\t\t\t\tself._switchToVisualEditor();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\twindowManager.destroy();\n\t\t\t\t\t\t\t\t} );\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} );\n\n\t\t\t\tswitchToolbar.setup( [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: 'editMode',\n\t\t\t\t\t\ttype: 'list',\n\t\t\t\t\t\ticon: 'edit',\n\t\t\t\t\t\ttitle: mw.msg( 'visualeditor-mweditmode-tooltip' ),\n\t\t\t\t\t\tinclude: [ 'editModeVisual', 'editModeSource' ]\n\t\t\t\t\t}\n\t\t\t\t] );\n\n\t\t\t\tself.$el.find( '.switcher-container' ).html( switchToolbar.$element );\n\t\t\t\tswitchToolbar.emit( 'updateState' );\n\t\t\t} );\n\t\t}\n\n\t\tEditorOverlayBase.prototype.postRender.apply( this );\n\n\t\tthis.$preview = this.$el.find( '.preview' );\n\t\tthis.$content = this.$el.find( '.wikitext-editor' );\n\t\tthis.$content.addClass( 'mw-editfont-' + mw.user.options.get( 'editfont' ) );\n\t\tif ( showAnonWarning ) {\n\t\t\tthis.$anonWarning = this.createAnonWarning( options );\n\t\t\tthis.$el.find( '.editor-container' ).append( this.$anonWarning );\n\t\t\tthis.$content.hide();\n\t\t\t// the user has to click login, signup or edit without login,\n\t\t\t// disable \"Next\" button on top right\n\t\t\tthis.$anonHiddenButtons = this.$el.find( '.overlay-header .continue, .editor-switcher' ).hide();\n\t\t\tthis.hideSpinner();\n\t\t}\n\t\t// make license links open in separate tabs\n\t\tthis.$el.find( '.license a' ).attr( 'target', '_blank' );\n\n\t\tthis.abuseFilterPanel = new AbuseFilterPanel( {\n\t\t\toverlayManager: this.overlayManager\n\t\t} ).appendTo( this.$el.find( '.panels' ) );\n\n\t\t// If in readOnly mode, make textarea readonly\n\t\tif ( this.readOnly ) {\n\t\t\tthis.$content.prop( 'readonly', true );\n\t\t}\n\n\t\tthis.$content.on( 'input', this._resizeEditor.bind( this ) );\n\n\t\tif ( !showAnonWarning ) {\n\t\t\tthis._loadContent();\n\t\t}\n\t},\n\n\t/**\n\t * Handles click on \"Edit without login\" in anonymous editing warning.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @private\n\t */\n\tonClickAnonymous: function () {\n\t\tthis.showSpinner();\n\t\tthis.$anonWarning.hide();\n\t\t// reenable \"Next\" button\n\t\tthis.$anonHiddenButtons.show();\n\t\tthis._loadContent();\n\t},\n\n\t/**\n\t * Prepares the preview interface and reveals the save screen of the overlay\n\t * @inheritdoc\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\tonStageChanges: function () {\n\t\tvar self = this,\n\t\t\tparams = {\n\t\t\t\ttext: this.getContent()\n\t\t\t};\n\n\t\tthis.scrollTop = util.getDocument().find( 'body' ).scrollTop();\n\t\tthis.$content.hide();\n\t\tthis.showSpinner();\n\n\t\tif ( mw.config.get( 'wgIsMainPage' ) ) {\n\t\t\tparams.mainpage = 1; // Setting it to 0 will have the same effect\n\t\t}\n\n\t\tfunction hideSpinnerAndShowPreview() {\n\t\t\tself.hideSpinner();\n\t\t\tself.$preview.show();\n\t\t}\n\n\t\tthis.gateway.getPreview( params ).then( function ( result ) {\n\t\t\tvar parsedText = result.text,\n\t\t\t\tparsedSectionLine = result.line;\n\n\t\t\tself.sectionId = result.id;\n\t\t\t// On desktop edit summaries strip tags. Mimic this behavior on mobile devices\n\t\t\tself.sectionLine = self.parseHTML( '<div>' ).html( parsedSectionLine ).text();\n\t\t\tnew Section( {\n\t\t\t\tel: self.$preview,\n\t\t\t\ttext: parsedText\n\t\t\t} ).$el.find( 'a' ).on( 'click', false );\n\n\t\t\thideSpinnerAndShowPreview();\n\t\t}, function () {\n\t\t\tself.$preview.addClass( 'error' ).text( mw.msg( 'mobile-frontend-editor-error-preview' ) );\n\n\t\t\thideSpinnerAndShowPreview();\n\t\t} );\n\n\t\tEditorOverlayBase.prototype.onStageChanges.apply( this, arguments );\n\t},\n\n\t/**\n\t * Hides the preview and reverts back to initial screen.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @private\n\t */\n\t_hidePreview: function () {\n\t\tthis.gateway.abortPreview();\n\t\tthis.hideSpinner();\n\t\tthis.$preview.removeClass( 'error' ).hide();\n\t\tthis.$content.show();\n\t\twindow.scrollTo( 0, this.scrollTop );\n\t\tthis.showHidden( '.initial-header' );\n\t\tthis.abuseFilterPanel.hide();\n\t},\n\n\t/**\n\t * Resize the editor textarea, maintaining scroll position in iOS\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\t_resizeEditor: function () {\n\t\tvar scrollTop, container, $scrollContainer;\n\n\t\t// exiting early for firefox due to a bug that causes the page to scroll to top\n\t\t// whenever a caret is inserted T214880\n\t\tif ( this.isFirefox ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( !this.$scrollContainer ) {\n\t\t\tcontainer = OO.ui.Element.static\n\t\t\t\t.getClosestScrollableContainer( this.$content[ 0 ] );\n\t\t\t// The scroll container will be either within the view\n\t\t\t// or the document element itself.\n\t\t\t$scrollContainer = this.$el.find( container ).length ?\n\t\t\t\tthis.$el.find( container ) : util.getDocument();\n\t\t\tthis.$scrollContainer = $scrollContainer;\n\t\t\tthis.$content.css( 'padding-bottom', this.$scrollContainer.height() * 0.6 );\n\t\t} else {\n\t\t\t$scrollContainer = this.$scrollContainer;\n\t\t}\n\n\t\t// Only do this if scroll container exists\n\t\tif ( this.$content.prop( 'scrollHeight' ) && $scrollContainer.length ) {\n\t\t\tscrollTop = $scrollContainer.scrollTop();\n\t\t\tthis.$content\n\t\t\t\t.css( 'height', 'auto' )\n\t\t\t\t// can't reuse prop( 'scrollHeight' ) because we need the current value\n\t\t\t\t.css( 'height', ( this.$content.prop( 'scrollHeight' ) + 2 ) + 'px' );\n\t\t\t$scrollContainer.scrollTop( scrollTop );\n\t\t}\n\t},\n\n\t/**\n\t * Set content to the user input field.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @param {string} content The content to set.\n\t */\n\tsetContent: function ( content ) {\n\t\tthis.$content\n\t\t\t.show()\n\t\t\t.val( content );\n\t\tthis._resizeEditor();\n\t},\n\n\t/**\n\t * Returns the content of the user input field.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @return {string}\n\t */\n\tgetContent: function () {\n\t\treturn this.$content.val();\n\t},\n\n\t/**\n\t * Requests content from the API and reveals it in UI.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @private\n\t */\n\t_loadContent: function () {\n\t\tvar self = this,\n\t\t\t$el = this.$el;\n\n\t\tthis.$content.hide();\n\t\tthis.showSpinner();\n\t\t$el.addClass( 'overlay-loading' );\n\n\t\t( this.dataPromise || this.gateway.getContent() )\n\t\t\t.then( function ( result ) {\n\t\t\t\tvar block, message,\n\t\t\t\t\tcontent = result.text;\n\n\t\t\t\tself.setContent( content );\n\t\t\t\tif ( self.gateway.fromModified ) {\n\t\t\t\t\t// Trigger intial EditorGateway#setContent and update save button\n\t\t\t\t\tself.onInputWikitextEditor();\n\t\t\t\t}\n\t\t\t\t// check if user is blocked\n\t\t\t\tif ( result.blockinfo ) {\n\t\t\t\t\t// Lazy-load moment only if it's needed,\n\t\t\t\t\t// it's somewhat large (it is already used on\n\t\t\t\t\t// mobile by Echo's notifications panel, where it's also lazy-loaded)\n\t\t\t\t\tmw.loader.using( 'moment' ).then( function () {\n\t\t\t\t\t\tblock = self.parseBlockInfo( result.blockinfo );\n\t\t\t\t\t\tmessage = blockMessageDrawer( block );\n\t\t\t\t\t\tmessage.toggle();\n\t\t\t\t\t\tself.hide();\n\t\t\t\t\t\tself.hideSpinner();\n\t\t\t\t\t\t$el.removeClass( 'overlay-loading' );\n\t\t\t\t\t} );\n\t\t\t\t} else {\n\t\t\t\t\tself.hideSpinner();\n\t\t\t\t\t$el.removeClass( 'overlay-loading' );\n\t\t\t\t}\n\t\t\t}, function () {\n\t\t\t\tself.reportError( mw.msg( 'mobile-frontend-editor-error-loading' ) );\n\t\t\t\t$el.removeClass( 'overlay-loading' );\n\t\t\t} );\n\t},\n\n\t/**\n\t * Loads a {VisualEditorOverlay} and replaces the existing SourceEditorOverlay with it\n\t * based on the current option values.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @private\n\t * @param {string} [wikitext] Wikitext to pass to VE\n\t */\n\t_switchToVisualEditor: function ( wikitext ) {\n\t\tvar self = this;\n\t\tthis.log( {\n\t\t\taction: 'abort',\n\t\t\ttype: 'switchnochange',\n\t\t\tmechanism: 'navigate'\n\t\t} );\n\t\tthis.logFeatureUse( {\n\t\t\tfeature: 'editor-switch',\n\t\t\taction: 'visual-mobile'\n\t\t} );\n\t\t// Save a user setting indicating that this user prefers using the VisualEditor\n\t\tmw.storage.set( 'preferredEditor', 'VisualEditor' );\n\t\t// Load the VisualEditor and replace the SourceEditor overlay with it\n\t\tthis.showSpinner();\n\t\tthis.$content.hide();\n\t\tmw.loader.using( 'ext.visualEditor.targetLoader' ).then( function () {\n\t\t\tmw.libs.ve.targetLoader.addPlugin( 'mobile.editor.ve' );\n\t\t\treturn mw.libs.ve.targetLoader.loadModules( 'visual' );\n\t\t} ).then(\n\t\t\tfunction () {\n\t\t\t\tvar options = self.getOptionsForSwitch();\n\t\t\t\toptions.SourceEditorOverlay = SourceEditorOverlay;\n\t\t\t\tself.hideSpinner();\n\t\t\t\tif ( wikitext ) {\n\t\t\t\t\toptions.dataPromise = mw.libs.ve.targetLoader.requestPageData( 'visual', mw.config.get( 'wgRelevantPageName' ), {\n\t\t\t\t\t\tsection: options.sectionId,\n\t\t\t\t\t\toldId: options.oldId || mw.config.get( 'wgRevisionId' ),\n\t\t\t\t\t\ttargetName: 'mobile',\n\t\t\t\t\t\tmodified: true,\n\t\t\t\t\t\twikitext: wikitext\n\t\t\t\t\t} );\n\t\t\t\t} else {\n\t\t\t\t\tdelete options.dataPromise;\n\t\t\t\t}\n\t\t\t\tself.switching = true;\n\t\t\t\tself.overlayManager.replaceCurrent( new VisualEditorOverlay( options ) );\n\t\t\t\tself.switching = false;\n\t\t\t},\n\t\t\tfunction () {\n\t\t\t\tself.hideSpinner();\n\t\t\t\tself.$content.show();\n\t\t\t\t// FIXME: We should show an error notification, but right now toast\n\t\t\t\t// notifications are not dismissible when shown within the editor.\n\t\t\t}\n\t\t);\n\t},\n\n\t/**\n\t * Reveals an abuse filter panel inside the view.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @private\n\t * @param {string} type The type of alert, e.g. 'warning' or 'disallow'\n\t * @param {string} message Message to show in the AbuseFilter overlay\n\t */\n\t_showAbuseFilter: function ( type, message ) {\n\t\tthis.abuseFilterPanel.show( type, message );\n\t\tthis.showHidden( '.save-header' );\n\t\t// disable continue and save buttons, reenabled when user changes content\n\t\tthis.$el.find( '.continue, .submit' ).prop( 'disabled', this.abuseFilterPanel.isDisallowed );\n\t},\n\n\t/**\n\t * Executed when the editor clicks the save/publish button. Handles logging and submitting\n\t * the save action to the editor API.\n\t * @inheritdoc\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\tonSaveBegin: function () {\n\t\tvar self = this,\n\t\t\toptions = {\n\t\t\t\tsummary: this.$el.find( '.summary' ).val()\n\t\t\t};\n\n\t\tif ( self.sectionLine !== '' ) {\n\t\t\toptions.summary = '/* ' + self.sectionLine + ' */' + options.summary;\n\t\t}\n\t\tEditorOverlayBase.prototype.onSaveBegin.apply( this, arguments );\n\t\tif ( this.confirmAborted ) {\n\t\t\treturn;\n\t\t}\n\t\tif ( this.captchaId ) {\n\t\t\toptions.captchaId = this.captchaId;\n\t\t\toptions.captchaWord = this.$el.find( '.captcha-word' ).val();\n\t\t}\n\n\t\tthis.showHidden( '.saving-header' );\n\n\t\tthis.gateway.save( options )\n\t\t\t.then( function ( newRevId ) {\n\t\t\t\tvar title = self.options.title;\n\t\t\t\t// Special case behaviour of main page\n\t\t\t\tif ( mw.config.get( 'wgIsMainPage' ) ) {\n\t\t\t\t\t// FIXME: Blocked on T189173\n\t\t\t\t\t// eslint-disable-next-line no-restricted-properties\n\t\t\t\t\twindow.location = mw.util.getUrl( title );\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tself.onSaveComplete( newRevId );\n\t\t\t}, function ( data ) {\n\t\t\t\tself.onSaveFailure( data );\n\t\t\t} );\n\t},\n\n\t/**\n\t * Executed when page save fails. Handles error display and bookkeeping,\n\t * passes logging duties to the parent.\n\t * @inheritdoc\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t */\n\tonSaveFailure: function ( data ) {\n\t\tvar heading, msg;\n\n\t\tif ( data.type === 'captcha' ) {\n\t\t\tthis.captchaId = data.details.id;\n\t\t\tthis.handleCaptcha( data.details );\n\t\t} else if ( data.type === 'abusefilter' ) {\n\t\t\tthis._showAbuseFilter( data.details.type, data.details.message );\n\t\t} else {\n\t\t\tmsg = saveFailureMessage( data );\n\t\t\tif ( data.type === 'readonly' ) {\n\t\t\t\theading = mw.msg( 'apierror-readonly' );\n\t\t\t}\n\n\t\t\tif ( msg || heading ) {\n\t\t\t\tthis.reportError( msg, heading );\n\t\t\t\tthis.showHidden( '.save-header, .save-panel' );\n\t\t\t}\n\t\t}\n\n\t\tEditorOverlayBase.prototype.onSaveFailure.apply( this, arguments );\n\t},\n\n\t/**\n\t * Checks whether the existing content has changed.\n\t * @memberof SourceEditorOverlay\n\t * @instance\n\t * @return {boolean}\n\t */\n\thasChanged: function () {\n\t\treturn this.gateway.hasChanged;\n\t}\n} );\n\nmodule.exports = SourceEditorOverlay;\n","/* global ve, $ */\nvar EditorOverlayBase = require( './EditorOverlayBase' ),\n\tEditorGateway = require( './EditorGateway' ),\n\tblockMessageDrawer = require( './blockMessageDrawer' ),\n\tmfExtend = require( '../mobile.startup/mfExtend' ),\n\trouter = mw.loader.require( 'mediawiki.router' ),\n\tidentifyLeadParagraph = require( './identifyLeadParagraph' ),\n\tutil = require( '../mobile.startup/util' );\n\n/**\n * Overlay for VisualEditor view\n * @class VisualEditorOverlay\n * @extends EditorOverlayBase\n *\n * @param {Object} options Configuration options\n * @param {SourceEditorOverlay} options.SourceEditorOverlay Class to use for standard\n *  Wikitext editor. It must be passed in explicitly to avoid a cyclic\n *  dependency between VisualEditorOverlay and SourceEditorOverlay\n */\nfunction VisualEditorOverlay( options ) {\n\tEditorOverlayBase.call( this,\n\t\tutil.extend( {\n\t\t\teditSwitcher: false,\n\t\t\thasToolbar: true,\n\t\t\tonBeforeExit: this.onBeforeExit.bind( this ),\n\t\t\tisBorderBox: false,\n\t\t\tclassName: 'overlay editor-overlay editor-overlay-ve'\n\t\t}, options )\n\t);\n\tthis.SourceEditorOverlay = options.SourceEditorOverlay;\n\tthis.isNewPage = options.isNewPage;\n\tthis.fromModified = options.dataPromise && options.switched;\n\n\t// Gateway present for a few utility purposes; the VE articletarget\n\t// handles the actual API calls separately\n\tthis.gateway = new EditorGateway( {\n\t\tapi: options.api,\n\t\ttitle: options.title,\n\t\tsectionId: options.sectionId,\n\t\toldId: options.oldId,\n\t\tisNewPage: options.isNewPage\n\t} );\n}\n\nmfExtend( VisualEditorOverlay, EditorOverlayBase, {\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\ttemplatePartials: util.extend( {}, EditorOverlayBase.prototype.templatePartials, {\n\t\teditHeader: util.template( `\n<div class=\"overlay-header header initial-header hideable hidden\">\n\t<div class=\"toolbar\"></div>\n</div>\n\t\t` ),\n\t\tcontent: util.template( `\n<div class=\"surface\" lang=\"{{contentLang}}\" dir=\"{{contentDir}}\">\n</div>\n\t\t` )\n\t} ),\n\t/**\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\teditor: 'visualeditor',\n\t/**\n\t * Destroy the existing VisualEditor target.\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tdestroyTarget: function () {\n\t\tif ( this.target ) {\n\t\t\tthis.target.destroy();\n\t\t\tthis.target = null;\n\t\t}\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tshow: function () {\n\t\tvar overlay = this,\n\t\t\toptions = this.options,\n\t\t\tshowAnonWarning = options.isAnon && !options.switched;\n\n\t\tEditorOverlayBase.prototype.show.apply( this, arguments );\n\n\t\t// We don't use the default spinner. Instead, rely on the progressbar from init/editor.js.\n\t\tif ( !this.options.switched ) {\n\t\t\tthis.hideSpinner();\n\t\t\tthis.$el.addClass( 'loading' );\n\t\t}\n\n\t\tthis.target = ve.init.mw.targetFactory.create( 'article', this, {\n\t\t\t$element: this.$el,\n\t\t\tsection: this.options.sectionId\n\t\t} );\n\t\tthis.target.once( 'surfaceReady', function () {\n\t\t\tthis.emit( 'editor-loaded' );\n\t\t\tthis.$el.removeClass( 'loading' );\n\t\t\tthis.scrollToLeadParagraph();\n\t\t\t// log edit attempt\n\t\t\toverlay.log( { action: 'ready' } );\n\t\t\toverlay.log( { action: 'loaded' } );\n\t\t}.bind( this ) );\n\t\tthis.dataPromise = this.target.load( this.options.dataPromise );\n\n\t\tif ( showAnonWarning ) {\n\t\t\tthis.$anonWarning = this.createAnonWarning( this.options );\n\t\t\tthis.$el.append( this.$anonWarning );\n\t\t\tthis.$el.find( '.overlay-content' ).hide();\n\t\t\tthis.$el.removeClass( 'loading' );\n\t\t} else {\n\t\t\tthis.checkForBlocks();\n\t\t}\n\t},\n\t/**\n\t * Scroll so that the lead paragraph in edit mode shows at the same place on the screen\n\t * as the lead paragraph in read mode.\n\t *\n\t * Their normal position is different because of (most importantly) the lead paragraph\n\t * transformation to move it before the infobox, and also invisible templates and slugs\n\t * caused by the presence of hatnote templates (both only shown in edit mode).\n\t */\n\tscrollToLeadParagraph: function () {\n\t\tvar editLead, readLead, offset,\n\t\t\tcurrentPageHTMLParser = this.options.currentPageHTMLParser,\n\t\t\tfakeScroll = this.options.fakeScroll,\n\t\t\t$window = $( window ),\n\t\t\tsection = this.target.section,\n\t\t\tsurface = this.target.getSurface(),\n\t\t\tmode = surface.getMode();\n\n\t\tif ( ( section === null || section === 0 ) && mode === 'visual' ) {\n\t\t\teditLead = identifyLeadParagraph( surface.getView().$attachedRootNode );\n\t\t\treadLead = identifyLeadParagraph( currentPageHTMLParser.getLeadSectionElement() );\n\n\t\t\tif ( editLead && readLead ) {\n\t\t\t\toffset = $( editLead ).offset().top - ( $( readLead ).offset().top - fakeScroll );\n\t\t\t\t$window.scrollTop( $window.scrollTop() + offset );\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tonBeforeExit: function ( exit ) {\n\t\tvar overlay = this;\n\t\tEditorOverlayBase.prototype.onBeforeExit.call( this, function () {\n\t\t\t// If this function is called, the parent method has decided that we should exit\n\t\t\texit();\n\t\t\t// VE-specific cleanup\n\t\t\toverlay.destroyTarget();\n\t\t} );\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tonClickBack: function () {\n\t\tEditorOverlayBase.prototype.onClickBack.apply( this, arguments );\n\t\tthis.switchToEditor();\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tonClickAnonymous: function () {\n\t\tvar self = this;\n\t\tthis.$anonWarning.hide();\n\t\tthis.checkForBlocks().then( function () {\n\t\t\tself.$el.find( '.overlay-content' ).show();\n\t\t} );\n\t},\n\n\t/**\n\t * Check if the user is blocked, and close the editor if they are\n\t *\n\t * @return {jQuery.Promise} Promise which resolves when the check is complete\n\t */\n\tcheckForBlocks: function () {\n\t\tvar self = this;\n\t\treturn this.dataPromise.then( function ( data ) {\n\t\t\tif ( data.visualeditor && data.visualeditor.blockinfo ) {\n\t\t\t\t// Lazy-load moment only if it's needed,\n\t\t\t\t// it's somewhat large (it is already used on\n\t\t\t\t// mobile by Echo's notifications panel, where it's also lazy-loaded)\n\t\t\t\tmw.loader.using( 'moment' ).then( function () {\n\t\t\t\t\tvar block = self.parseBlockInfo( data.visualeditor.blockinfo ),\n\t\t\t\t\t\tmessage = blockMessageDrawer( block );\n\t\t\t\t\tmessage.toggle();\n\t\t\t\t\tself.hide();\n\t\t\t\t} );\n\t\t\t}\n\t\t} );\n\t},\n\n\t/**\n\t * Reveal the editing interface.\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tswitchToEditor: function () {\n\t\tthis.showHidden( '.initial-header' );\n\t},\n\t/**\n\t * Loads an {SourceEditorOverlay} and replaces the existing {VisualEditorOverlay}\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t * @param {jQuery.Promise} [dataPromise] Optional promise for loading content\n\t */\n\tswitchToSourceEditor: function ( dataPromise ) {\n\t\tvar self = this,\n\t\t\tSourceEditorOverlay = this.SourceEditorOverlay,\n\t\t\toptions = this.getOptionsForSwitch();\n\t\tthis.log( {\n\t\t\taction: 'abort',\n\t\t\ttype: 'switchnochange',\n\t\t\tmechanism: 'navigate'\n\t\t} );\n\t\tthis.logFeatureUse( {\n\t\t\tfeature: 'editor-switch',\n\t\t\taction: 'source-mobile'\n\t\t} );\n\n\t\t// Save a user setting indicating that this user prefers using the SourceEditor\n\t\tmw.storage.set( 'preferredEditor', 'SourceEditor' );\n\t\tthis.showSpinner();\n\t\tthis.$el.find( '.surface' ).hide();\n\t\tself.hideSpinner();\n\t\tif ( dataPromise ) {\n\t\t\t// If switching with edits we can't stay in section editing, as a VE edit\n\t\t\t// can always affect the whole document (e.g. references)\n\t\t\toptions.sectionId = null;\n\t\t\trouter.navigateTo( document.title, {\n\t\t\t\tpath: '#/editor/all',\n\t\t\t\tuseReplaceState: true\n\t\t\t} );\n\t\t}\n\t\tself.switching = true;\n\t\tself.overlayManager.replaceCurrent( new SourceEditorOverlay( options, dataPromise ) );\n\t\tself.switching = false;\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\tonSaveComplete: function () {\n\t\tEditorOverlayBase.prototype.onSaveComplete.apply( this, arguments );\n\t\tthis.destroyTarget();\n\t},\n\t/**\n\t * @inheritdoc\n\t * @memberof VisualEditorOverlay\n\t * @instance\n\t */\n\thasChanged: function () {\n\t\tif ( this.saved ) {\n\t\t\t// If we just saved, there's not really any changes, and the\n\t\t\t// target is going to be destroyed in one tick\n\t\t\treturn false;\n\t\t}\n\t\treturn this.fromModified || (\n\t\t\tthis.target &&\n\t\t\tthis.target.getSurface() &&\n\t\t\tthis.target.getSurface().getModel().hasBeenModified()\n\t\t);\n\t}\n} );\n\nmodule.exports = VisualEditorOverlay;\n","var Drawer = require( '../mobile.startup/Drawer' ),\n\tBlockMessageDetails = require( './BlockMessageDetails' ),\n\tIcon = require( '../mobile.startup/Icon' );\n/**\n * @typedef {Object} BlockMessageOptions\n * @property {number} blockId representing the block\n * @property {boolean} partial is this a partial block?\n * @property {Object} creator\n * @property {string} creator.name of the blocker\n * @property {string} creator.url associated with the block\n * @property {string} reason for block\n * @property {string} [duration] of block\n * @property {string} [expiry] of block\n */\n\n/**\n * This creates the drawer at the bottom of the screen that appears when a\n * blocked user tries to edit.\n * @param {BlockMessageOptions} props\n * @return {Drawer}\n */\nmodule.exports = function blockMessageDrawer( props ) {\n\treturn new Drawer( {\n\t\tclassName: 'drawer block-message',\n\t\tchildren: [\n\t\t\t( new Icon( {\n\t\t\t\tname: 'stop-hand',\n\t\t\t\tadditionalClassNames: 'block-message-icon'\n\t\t\t} ) ).$el,\n\t\t\t( new BlockMessageDetails( props ) ).$el\n\t\t]\n\t} );\n};\n","/* global $ */\n/**\n * Find first paragraph that has text content, i.e. paragraphs that are not empty.\n * Keep in sync with MoveLeadParagraphTransform::identifyLeadParagraph().\n *\n * @param {jQuery} $body Where to search for paragraphs\n * @return {Node} The lead paragraph\n */\nmodule.exports = function identifyLeadParagraph( $body ) {\n\tvar $paragraphs, i, node;\n\n\t// Keep in sync with MoveLeadParagraphTransform::isNotEmptyNode()\n\tfunction isNotEmptyNode( node ) {\n\t\treturn /\\S/.test( node.textContent );\n\t}\n\n\t// Keep in sync with MoveLeadParagraphTransform::isNonLeadParagraph()\n\tfunction isNonLeadParagraph( node ) {\n\t\tvar $coords;\n\t\tif ( isNotEmptyNode( node ) ) {\n\t\t\t$coords = $( node ).find( 'span#coordinates' );\n\t\t\tif ( !$coords.length ) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif ( node.textContent ) {\n\t\t\t\treturn node.textContent === $coords[ 0 ].textContent;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\t$paragraphs = $body.children( 'p' );\n\tfor ( i = 0; i < $paragraphs.length; i++ ) {\n\t\tnode = $paragraphs[ i ];\n\t\tif ( !isNonLeadParagraph( node ) ) {\n\t\t\treturn node;\n\t\t}\n\t}\n\treturn null;\n};\n","var m = require( './../mobile.startup/moduleLoaderSingleton' ),\n\tSourceEditorOverlay = require( './SourceEditorOverlay' ),\n\tVisualEditorOverlay = require( './VisualEditorOverlay' ),\n\tschemaEditAttemptStep = require( './schemaEditAttemptStep' );\n\n// Exposed for MobileFrontend mobile.init usage.\nm.define( 'mobile.editor.overlay/SourceEditorOverlay', SourceEditorOverlay );\nm.define( 'mobile.editor.overlay/VisualEditorOverlay', VisualEditorOverlay );\n// setup schema:edit logging\nschemaEditAttemptStep();\n","/**\n * Build a save failure message from the API response\n * @param {Object} data Details about the failure, from EditorGateway.parseSaveError\n * @return {string} message describing the failure for display to the user\n */\nmodule.exports = function saveFailureMessage( data ) {\n\tvar key = data && data.details && data.details.code,\n\t\t// When save failed with one of these error codes, the returned\n\t\t// message in response.error.info will be forwarded to the user.\n\t\t// FIXME: This shouldn't be needed when info texts are all localized.\n\t\twhitelistedErrorInfo = [\n\t\t\t'blocked',\n\t\t\t'autoblocked'\n\t\t];\n\tif ( data.type === 'readonly' ) {\n\t\treturn data.details.readonlyreason;\n\t}\n\tif ( key === 'editconflict' ) {\n\t\treturn mw.msg( 'mobile-frontend-editor-error-conflict' );\n\t} else if ( whitelistedErrorInfo.indexOf( key ) > -1 ) {\n\t\treturn data.error.info;\n\t}\n\treturn mw.msg( 'mobile-frontend-editor-error' );\n};\n","module.exports = function () {\n\tvar trackdebug = !!mw.util.getParamValue( 'trackdebug' );\n\n\tif ( !mw.config.exists( 'wgWMESchemaEditAttemptStepSamplingRate' ) ) {\n\t\treturn;\n\t}\n\n\tmw.loader.using( [ 'ext.eventLogging' ] ).then( function () {\n\t\tvar // Schema class is provided by ext.eventLogging\n\t\t\tSchema = mw.eventLog.Schema,\n\t\t\tuser = mw.user,\n\t\t\tsampleRate = mw.config.get( 'wgWMESchemaEditAttemptStepSamplingRate' ),\n\t\t\tactionPrefixMap = {\n\t\t\t\tsaveIntent: 'save_intent',\n\t\t\t\tsaveAttempt: 'save_attempt',\n\t\t\t\tsaveSuccess: 'save_success',\n\t\t\t\tsaveFailure: 'save_failure'\n\t\t\t},\n\t\t\ttiming = {},\n\t\t\t/**\n\t\t\t * Edit schema\n\t\t\t * https://meta.wikimedia.org/wiki/Schema:EditAttemptStep\n\t\t\t */\n\t\t\t/* eslint-disable camelcase */\n\t\t\tschemaEditAttemptStep = new Schema(\n\t\t\t\t'EditAttemptStep',\n\t\t\t\tsampleRate,\n\t\t\t\t{\n\t\t\t\t\tpage_id: mw.config.get( 'wgArticleId' ),\n\t\t\t\t\trevision_id: mw.config.get( 'wgRevisionId' ),\n\t\t\t\t\tpage_title: mw.config.get( 'wgPageName' ),\n\t\t\t\t\tpage_ns: mw.config.get( 'wgNamespaceNumber' ),\n\t\t\t\t\tuser_id: user.getId(),\n\t\t\t\t\tuser_class: user.isAnon() ? 'IP' : undefined,\n\t\t\t\t\tuser_editcount: mw.config.get( 'wgUserEditCount', 0 ),\n\t\t\t\t\tmw_version: mw.config.get( 'wgVersion' ),\n\t\t\t\t\tplatform: 'phone',\n\t\t\t\t\tintegration: 'page',\n\t\t\t\t\tpage_token: user.getPageviewToken(),\n\t\t\t\t\tsession_token: user.sessionId(),\n\t\t\t\t\tversion: 1\n\t\t\t\t}\n\t\t\t);\n\t\t\t/* eslint-enable camelcase */\n\n\t\tif ( mw.config.get( 'wgMFSchemaEditAttemptStepAnonymousUserId' ) ) {\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\tschemaEditAttemptStep.defaults.anonymous_user_token = mw.config.get( 'wgMFSchemaEditAttemptStepAnonymousUserId' );\n\t\t}\n\t\tif ( mw.config.get( 'wgMFSchemaEditAttemptStepBucket' ) ) {\n\t\t\tschemaEditAttemptStep.defaults.bucket = mw.config.get( 'wgMFSchemaEditAttemptStepBucket' );\n\t\t}\n\n\t\tfunction log() {\n\t\t\t// mw.log is a no-op unless resource loader is in debug mode, so\n\t\t\t// this allows trackdebug to work independently (T211698)\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.log.apply( console, arguments );\n\t\t}\n\n\t\tfunction computeDuration( action, event, timeStamp ) {\n\t\t\t// This is duplicated from the VisualEditor extension\n\t\t\t// (ve.init.mw.trackSubscriber.js). Changes to this should be kept in\n\t\t\t// sync with that file, so the data remains consistent.\n\t\t\tif ( event.timing !== undefined ) {\n\t\t\t\treturn event.timing;\n\t\t\t}\n\n\t\t\tswitch ( action ) {\n\t\t\t\tcase 'ready':\n\t\t\t\t\treturn timeStamp - timing.init;\n\t\t\t\tcase 'loaded':\n\t\t\t\t\treturn timeStamp - timing.init;\n\t\t\t\tcase 'saveIntent':\n\t\t\t\t\treturn timeStamp - timing.ready;\n\t\t\t\tcase 'saveAttempt':\n\t\t\t\t\treturn timeStamp - timing.saveIntent;\n\t\t\t\tcase 'saveSuccess':\n\t\t\t\tcase 'saveFailure':\n\t\t\t\t\t// HERE BE DRAGONS: the caller must compute these themselves\n\t\t\t\t\t// for sensible results. Deliberately sabotage any attempts to\n\t\t\t\t\t// use the default by returning -1\n\t\t\t\t\tmw.log.warn( 'mf.schemaEditAttemptStep: Do not rely on default timing value for saveSuccess/saveFailure' );\n\t\t\t\t\treturn -1;\n\t\t\t\tcase 'abort':\n\t\t\t\t\tswitch ( event.abort_type ) {\n\t\t\t\t\t\tcase 'preinit':\n\t\t\t\t\t\t\treturn timeStamp - timing.init;\n\t\t\t\t\t\tcase 'nochange':\n\t\t\t\t\t\tcase 'switchwith':\n\t\t\t\t\t\tcase 'switchwithout':\n\t\t\t\t\t\tcase 'switchnochange':\n\t\t\t\t\t\tcase 'abandon':\n\t\t\t\t\t\t\treturn timeStamp - timing.ready;\n\t\t\t\t\t\tcase 'abandonMidsave':\n\t\t\t\t\t\t\treturn timeStamp - timing.saveAttempt;\n\t\t\t\t\t}\n\t\t\t\t\tmw.log.warn( 'mf.schemaEditAttemptStep: Unrecognized abort type', event.type );\n\t\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tmw.log.warn( 'mf.schemaEditAttemptStep: Unrecognized action', action );\n\t\t\treturn -1;\n\t\t}\n\n\t\tmw.trackSubscribe( 'mf.schemaEditAttemptStep', function ( topic, data, timeStamp ) {\n\t\t\tvar actionPrefix = actionPrefixMap[ data.action ] || data.action,\n\t\t\t\tduration = 0;\n\n\t\t\ttimeStamp = timeStamp || this.timeStamp; // I8e82acc12 back-compat\n\n\t\t\t// Schema's kind of a mess of special properties\n\t\t\tif ( data.action === 'init' || data.action === 'abort' || data.action === 'saveFailure' ) {\n\t\t\t\tdata[ actionPrefix + '_type' ] = data.type;\n\t\t\t}\n\t\t\tif ( data.action === 'init' || data.action === 'abort' ) {\n\t\t\t\tdata[ actionPrefix + '_mechanism' ] = data.mechanism;\n\t\t\t}\n\t\t\tif ( data.action !== 'init' ) {\n\t\t\t\t// Schema actually does have an init_timing field, but we don't want to\n\t\t\t\t// store it because it's not meaningful.\n\t\t\t\tduration = Math.round( computeDuration( data.action, data, timeStamp ) );\n\t\t\t\tdata[ actionPrefix + '_timing' ] = duration;\n\t\t\t}\n\t\t\tif ( data.action === 'saveFailure' ) {\n\t\t\t\tdata[ actionPrefix + '_message' ] = data.message;\n\t\t\t}\n\n\t\t\t// Remove renamed properties\n\t\t\tdelete data.type;\n\t\t\tdelete data.mechanism;\n\t\t\tdelete data.timing;\n\t\t\tdelete data.message;\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\tdata.is_oversample =\n\t\t\t\t!mw.eventLog.inSample( 1 / sampleRate );\n\n\t\t\tif ( data.action === 'abort' && data.abort_type !== 'switchnochange' ) {\n\t\t\t\ttiming = {};\n\t\t\t} else {\n\t\t\t\ttiming[ data.action ] = timeStamp;\n\t\t\t}\n\n\t\t\t// Switching between visual and source produces a chain of\n\t\t\t// abort/ready/loaded events and no init event, so suppress them for\n\t\t\t// consistency with desktop VE's logging.\n\t\t\tif ( data.abort_type === 'switchnochange' ) {\n\t\t\t\t// The initial abort, flagged as a switch\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ( timing.abort ) {\n\t\t\t\t// An abort was previously logged\n\t\t\t\tif ( data.action === 'ready' ) {\n\t\t\t\t\t// Just discard the ready\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif ( data.action === 'loaded' ) {\n\t\t\t\t\t// Switch has finished; remove the abort timing so we stop discarding events.\n\t\t\t\t\tdelete timing.abort;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ( trackdebug ) {\n\t\t\t\tlog( topic + '.' + data.action, duration + 'ms', data, schemaEditAttemptStep.defaults );\n\t\t\t} else {\n\t\t\t\tschemaEditAttemptStep.log( data, (\n\t\t\t\t\tmw.config.get( 'wgWMESchemaEditAttemptStepOversample' ) ||\n\t\t\t\t\tmw.config.get( 'wgMFSchemaEditAttemptStepOversample' ) === 'all' ||\n\t\t\t\t\t// wikitext / visualeditor\n\t\t\t\t\tdata.editor_interface === mw.config.get( 'wgMFSchemaEditAttemptStepOversample' )\n\t\t\t\t) ? 1 : sampleRate );\n\t\t\t}\n\t\t} );\n\n\t} );\n};\n"],"sourceRoot":""}