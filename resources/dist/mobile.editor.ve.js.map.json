{"version":3,"sources":["webpack://mfModules.[name]/./src/mobile.editor.ve/mobile.editor.ve.js","webpack://mfModules.[name]/./src/mobile.editor.ve/schemaVisualEditorFeatureUse.js","webpack://mfModules.[name]/./src/mobile.editor.ve/ve.init.mw.MobileFrontendArticleTarget.js"],"names":["MobileFrontendArticleTarget","require","schemaVisualEditorFeatureUse","ve","init","mw","targetFactory","register","trackSubscribe","topic","data","track","extendObject","feature","split","editing_session_id","target","overlay","sessionId","module","exports","trackdebug","util","getParamValue","loader","getState","using","then","Schema","eventLog","sampleRate","config","get","event","action","editingSessionId","console","log","apply","arguments","MobileArticleTarget","parseSaveError","Target","this","$overlay","$el","$overlaySurface","find","useScrollContainer","platform","constructor","static","isIos","super","call","$element","addClass","OO","inheritClass","prototype","destroy","css","getScrollContainer","isToolbarOverSurface","onContainerScroll","onSurfaceScroll","nativeSelection","range","getSurface","getView","rangeCount","document","activeElement","contentEditable","getRangeAt","removeAllRanges","addRange","createSurface","dmDoc","surface","isNewPage","placeholder","msg","user","connect","scroll","setSurface","changed","append","surfaceReady","hideSpinner","removeClass","getContext","resize","adjustContentPadding","maybeShowWelcomeDialog","toolbarHeight","getToolbar","outerHeight","setToolbarHeight","scrollCursorIntoView","loadFail","key","text","reportError","hide","editSource","getModel","hasBeenModified","ui","confirm","confirmed","showSaveDialog","switchToSourceEditor","save","saveComplete","fragment","getSectionFragmentFromPage","sectionId","onSaveComplete","saveFail","doc","saveData","wasRetry","jqXHR","status","response","onSaveFailure","tryTeardown","window","history","back"],"mappings":"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","file":"mobile.editor.ve.js","sourcesContent":["/* global ve */\nvar MobileFrontendArticleTarget = require( './ve.init.mw.MobileFrontendArticleTarget' ),\n\tschemaVisualEditorFeatureUse = require( './schemaVisualEditorFeatureUse' );\n\n// register\nve.init.mw.MobileFrontendArticleTarget = MobileFrontendArticleTarget;\nve.init.mw.targetFactory.register( MobileFrontendArticleTarget );\nschemaVisualEditorFeatureUse();\n// Hook up activity-tracking from VE's system to mobilefrontend's system\nve.trackSubscribe( 'activity.', function ( topic, data ) {\n\tmw.track( 'mf.schemaVisualEditorFeatureUse', ve.extendObject( data, {\n\t\tfeature: topic.split( '.' )[ 1 ],\n\t\t// eslint-disable-next-line camelcase\n\t\tediting_session_id: ve.init.target.overlay.sessionId\n\t} ) );\n} );\n","module.exports = function () {\n\tvar trackdebug = !!mw.util.getParamValue( 'trackdebug' );\n\n\tif ( mw.loader.getState( 'schema.VisualEditorFeatureUse' ) === null && !trackdebug ) {\n\t\treturn;\n\t}\n\n\t// VisualEditorFeatureUse is intended to log whenever EditAttemptStep\n\t// does, so this file references its config for sampling rates and\n\t// oversampling.\n\n\tmw.loader.using( [ 'ext.eventLogging.subscriber' ] ).then( function () {\n\t\tvar // Schema provided by ext.eventLogging.subscriber class\n\t\t\tSchema = mw.eventLog.Schema, // resource-modules-disable-line\n\t\t\tsampleRate = mw.config.get( 'wgWMESchemaEditAttemptStepSamplingRate' ),\n\t\t\t/**\n\t\t\t * Feature use schema\n\t\t\t * https://meta.wikimedia.org/wiki/Schema:VisualEditorFeatureUse\n\t\t\t */\n\t\t\tschemaVisualEditorFeatureUse = new Schema(\n\t\t\t\t'VisualEditorFeatureUse',\n\t\t\t\tsampleRate\n\t\t\t);\n\n\t\tfunction log() {\n\t\t\t// mw.log is a no-op unless resource loader is in debug mode, so\n\t\t\t// this allows trackdebug to work independently (T211698)\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.log.apply( console, arguments );\n\t\t}\n\n\t\tmw.trackSubscribe( 'mf.schemaVisualEditorFeatureUse', function ( topic, data ) {\n\t\t\tvar event = {\n\t\t\t\tfeature: data.feature,\n\t\t\t\taction: data.action,\n\t\t\t\teditingSessionId: data.editing_session_id\n\t\t\t};\n\n\t\t\tif ( trackdebug ) {\n\t\t\t\tlog( topic, event );\n\t\t\t} else {\n\t\t\t\tschemaVisualEditorFeatureUse.log( event, (\n\t\t\t\t\tmw.config.get( 'wgWMESchemaEditAttemptStepOversample' ) ||\n\t\t\t\t\tmw.config.get( 'wgMFSchemaEditAttemptStepOversample' ) === 'visualeditor' ||\n\t\t\t\t\tmw.config.get( 'wgMFSchemaEditAttemptStepOversample' ) === 'all'\n\t\t\t\t) ? 1 : sampleRate );\n\t\t\t}\n\t\t} );\n\n\t} );\n};\n","/*!\n * VisualEditor MediaWiki Initialization MobileFrontendArticleTarget class.\n *\n * @copyright 2011-2015 VisualEditor Team and others; see AUTHORS.txt\n * @license The MIT License (MIT); see LICENSE.txt\n */\n\n/* global ve */\nvar MobileArticleTarget = ve.init.mw.MobileArticleTarget,\n\tparseSaveError = require( '../mobile.editor.overlay/parseSaveError' ),\n\tTarget = ve.init.mw.Target;\n\n/**\n * MediaWiki mobile frontend article target.\n *\n * @class\n * @extends MobileArticleTarget\n *\n * @param {VisualEditorOverlay} overlay Mobile frontend overlay\n * @param {Object} [config] Configuration options\n */\nfunction MobileFrontendArticleTarget( overlay, config ) {\n\tthis.overlay = overlay;\n\tthis.$overlay = overlay.$el;\n\tthis.$overlaySurface = overlay.$el.find( '.surface' );\n\tthis.useScrollContainer = ve.init.platform.constructor.static.isIos();\n\n\t// Parent constructor\n\tMobileFrontendArticleTarget.super.call( this, config );\n\n\t// Initialization\n\tthis.$element.addClass( 've-init-mw-mobileFrontendArticleTarget' );\n}\n\n/* Inheritance */\n\nOO.inheritClass( MobileFrontendArticleTarget, MobileArticleTarget );\n\n/* Static Properties */\n\nMobileFrontendArticleTarget.static.parseSaveError = parseSaveError;\n\n/* Methods */\n\n/**\n * Destroy the target\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.destroy = function () {\n\t// Parent method\n\tMobileFrontendArticleTarget.super.prototype.destroy.call( this );\n\n\tthis.$overlay.css( 'padding-top', '' );\n};\n\n/*\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.getScrollContainer = function () {\n\tif ( this.useScrollContainer ) {\n\t\treturn this.overlay.$el.find( '.overlay-content' );\n\t}\n\t// Parent method\n\treturn MobileFrontendArticleTarget.super.prototype.getScrollContainer.call( this );\n};\n\n/*\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.isToolbarOverSurface = function () {\n\treturn true;\n};\n\n/**\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.onContainerScroll = function () {\n\t// MF provides the toolbar so there is no need to float the toolbar\n};\n\n/**\n * Handle surface scroll events\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.onSurfaceScroll = function () {\n\tvar nativeSelection, range;\n\n\tif ( ve.init.platform.constructor.static.isIos() ) {\n\t\t// iOS has a bug where if you change the scroll offset of a\n\t\t// contentEditable or textarea with a cursor visible, it disappears.\n\t\t// This function works around it by removing and reapplying the selection.\n\t\tnativeSelection = this.getSurface().getView().nativeSelection;\n\t\tif ( nativeSelection.rangeCount && document.activeElement.contentEditable === 'true' ) {\n\t\t\trange = nativeSelection.getRangeAt( 0 );\n\t\t\tnativeSelection.removeAllRanges();\n\t\t\tnativeSelection.addRange( range );\n\t\t}\n\t}\n};\n\n/*\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.createSurface = function ( dmDoc, config ) {\n\tvar surface;\n\tif ( this.overlay.isNewPage ) {\n\t\tconfig = ve.extendObject( {\n\t\t\tplaceholder: mw.msg( 'mobile-frontend-editor-placeholder-new-page', mw.user )\n\t\t}, config );\n\t}\n\n\t// Parent method\n\tsurface = MobileFrontendArticleTarget\n\t\t.super.prototype.createSurface.call( this, dmDoc, config );\n\n\tsurface.connect( this, { scroll: 'onSurfaceScroll' } );\n\n\treturn surface;\n};\n\n/**\n * @inheritdoc\n */\nMobileFrontendArticleTarget.prototype.setSurface = function ( surface ) {\n\tvar changed = surface !== this.surface;\n\n\t// Parent method\n\tTarget.super.prototype.setSurface.apply( this, arguments );\n\n\tif ( changed ) {\n\t\tsurface.$element.addClass( 'content loading' );\n\t\tthis.$overlaySurface.append( surface.$element );\n\t}\n};\n\n/**\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.surfaceReady = function () {\n\tvar surface = this.getSurface();\n\n\t// Parent method\n\tMobileFrontendArticleTarget.super.prototype.surfaceReady.apply( this, arguments );\n\n\tthis.overlay.hideSpinner();\n\tsurface.$element.removeClass( 'loading' );\n\n\tsurface.getContext().connect( this, { resize: 'adjustContentPadding' } );\n\tthis.adjustContentPadding();\n\n\tthis.maybeShowWelcomeDialog();\n};\n\n/**\n * Match the content padding to the toolbar height\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.adjustContentPadding = function () {\n\tvar toolbarHeight = this.getToolbar().$element.outerHeight(),\n\t\tsurface = this.getSurface();\n\tsurface.setToolbarHeight( toolbarHeight );\n\tthis.$overlay.css( 'padding-top', toolbarHeight );\n\tthis.getSurface().scrollCursorIntoView();\n};\n\n/*\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.loadFail = function ( key, text ) {\n\t// Parent method\n\tMobileFrontendArticleTarget.super.prototype.loadFail.apply( this, arguments );\n\n\tthis.overlay.reportError( text );\n\tthis.overlay.hide();\n};\n\n/**\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.editSource = function () {\n\tvar target = this;\n\t// If changes have been made tell the user they have to save first\n\tif ( !this.getSurface().getModel().hasBeenModified() ) {\n\t\tthis.overlay.switchToSourceEditor();\n\t} else {\n\t\tOO.ui.confirm( mw.msg( 'mobile-frontend-editor-switch-confirm' ) ).then( function ( confirmed ) {\n\t\t\tif ( confirmed ) {\n\t\t\t\ttarget.showSaveDialog();\n\t\t\t}\n\t\t} );\n\t}\n};\n\n/**\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.save = function () {\n\t// Parent method\n\tMobileFrontendArticleTarget.super.prototype.save.apply( this, arguments );\n\n\tthis.overlay.log( {\n\t\taction: 'saveAttempt'\n\t} );\n};\n\n/**\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.showSaveDialog = function () {\n\t// Parent method\n\tMobileFrontendArticleTarget.super.prototype.showSaveDialog.apply( this, arguments );\n\n\tthis.overlay.log( {\n\t\taction: 'saveIntent'\n\t} );\n};\n\n/**\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.saveComplete = function () {\n\tvar fragment = this.getSectionFragmentFromPage();\n\t// Parent method\n\tMobileFrontendArticleTarget.super.prototype.saveComplete.apply( this, arguments );\n\n\tthis.overlay.sectionId = fragment;\n\tthis.overlay.onSaveComplete();\n};\n\n/**\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n * @param {HTMLDocument} doc HTML document we tried to save\n * @param {Object} saveData Options that were used\n * @param {boolean} wasRetry Whether this was a retry after a 'badtoken' error\n * @param {Object} jqXHR\n * @param {string} status Text status message\n * @param {Object|null} response API response data\n */\n// eslint-disable-next-line max-len\nMobileFrontendArticleTarget.prototype.saveFail = function ( doc, saveData, wasRetry, jqXHR, status, response ) {\n\n\t// parent method\n\tMobileFrontendArticleTarget.super.prototype.saveFail.apply( this, arguments );\n\n\tthis.overlay.onSaveFailure( this.constructor.static.parseSaveError( response, status ) );\n};\n\n/**\n * FIXME: @inheritdoc once this file is in the right repo\n * @memberof MobileFrontendArticleTarget\n * @instance\n */\nMobileFrontendArticleTarget.prototype.tryTeardown = function () {\n\t// Parent method\n\tMobileFrontendArticleTarget.super.prototype.tryTeardown.apply( this, arguments )\n\t\t.then( function () {\n\t\t\t// eslint-disable-next-line no-restricted-properties\n\t\t\twindow.history.back();\n\t\t} );\n};\n\nmodule.exports = MobileFrontendArticleTarget;\n"],"sourceRoot":""}