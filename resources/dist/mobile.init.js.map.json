{"version":3,"sources":["webpack://mfModules.[name]/./src/mobile.init/BetaOptInPanel.js","webpack://mfModules.[name]/./src/mobile.init/editor.js","webpack://mfModules.[name]/./src/mobile.init/editorLoadingOverlay.js","webpack://mfModules.[name]/./src/mobile.init/eventLogging/schemaEditAttemptStep.js","webpack://mfModules.[name]/./src/mobile.init/eventLogging/schemaMobileWebSearch.js","webpack://mfModules.[name]/./src/mobile.init/eventLogging/schemaVisualEditorFeatureUse.js","webpack://mfModules.[name]/./src/mobile.init/mobile.init.js","webpack://mfModules.[name]/./src/mobile.init/toggling.js"],"names":["Button","require","util","View","user","mw","BetaOptInPanel","props","_classCallCheck","this","_possibleConstructorReturn","_getPrototypeOf","call","extend","isTemplateMode","events","click .optin","click .cancel","onCancel","$el","find","append","options","buttons","map","button","ev","currentTarget","closest","trigger","template","prototype","defaults","postUrl","undefined","editToken","tokens","get","text","msg","progressive","additionalClassNames","label","module","exports","M","editorLoadingOverlay","OverlayManager","$allEditLinks","$","popup","CtaDrawer","blacklisted","test","navigator","userAgent","contentModel","config","veConfig","editCount","editorPath","setupEditor","page","skin","currentPageHTMLParser","router","uri","fragment","editorOverride","overlayManager","getSingleton","isNewPage","id","on","elem","section","Uri","href","query","length","navigate","preventDefault","onEditLinkClick","add","sectionId","animationDelayDeferred","abortableDataPromise","loadingOverlay","overlayPromise","scrollbarWidth","window","innerWidth","document","documentElement","clientWidth","scrollTop","pageYOffset","$content","editorOptions","fakeScroll","api","Api","licenseMsg","getLicenseMsg","title","titleObj","isAnon","oldId","getParamValue","contentLang","attr","contentDir","sessionId","generateRandomSessionId","initMechanism","logInit","editor","track","action","type","mechanism","editor_interface","editing_session_id","shouldLoadVisualEditor","isVisualEditorEnabled","preferredEditor","storage","getPreferredEditor","visualEditorNamespaces","namespaces","isWikiText","indexOf","loadSourceEditor","hook","fire","loader","using","then","Deferred","$page","$sectionTop","enableVisualSectionEditing","body","addClass","css","padding-right","box-sizing","prop","getBoundingClientRect","top","transform","padding-bottom","margin-bottom","setTimeout","resolve","abort","removeClass","mode","dataPromise","libs","ve","targetLoader","requestPageData","getPrefixedDb","sessionStore","targetName","addPlugin","loadModules","VisualEditorOverlay","SourceEditorOverlay","Promise","all","overlay","getLoadingPromise","overlayData","stack","replaceCurrent","error","back","show","notify","i","toString","getPath","history","pushState","veaction","replaceState","init","currentPage","isReadOnly","editRestrictions","hide","hideSectionEditIcons","Array","isArray","drawer","content","signupQueryParams","warning","route","checkRoute","showLoginDrawer","showSorryToast","isMissing","isEditingSupported","isSupported","inNamespace","fakeToolbar","Overlay","afterShow","afterHide","$fakeToolbar","className","noHeader","isBorderBox","onBeforeExit","exit","appendTo","trackdebug","exists","Schema","eventLog","sampleRate","actionPrefixMap","firstChange","saveIntent","saveAttempt","saveSuccess","saveFailure","timing","schemaEditAttemptStep","page_id","revision_id","page_title","page_ns","user_id","getId","user_class","user_editcount","mw_version","platform","integration","page_token","getPageviewToken","session_token","version","anonymous_user_token","bucket","trackSubscribe","topic","data","timeStamp","actionPrefix","duration","Math","round","event","ready","log","warn","abort_type","computeDuration","message","is_oversample","inSample","console","apply","arguments","schemaMobileWebSearch","platformVersion","schemaVisualEditorFeatureUse","feature","editingSessionId","toggling","skinName","isPageContentModelEditable","mfUtil","$window","getWindow","$html","getDocument","experiments","activeExperiments","Skin","eventBus","apply2","fn1","fn2","updateFontSize","userFontSize","debounce","emit","throttle","betaoptin","experiment","pageHTMLParser","betaOptInPanel","inStable","token","isMainPage","set","getBucket","getUrl","returnto","remove","getLeadSectionElement","isPanelShown","displayBetaOptIn","mobileFrontend","deprecate","$contentContainer","Toggler","$container","prefix","removeAttr","mfTempOpenSection"],"mappings":"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","file":"mobile.init.js","sourcesContent":["var Button = require( '../mobile.startup/Button' ),\n\tutil = require( '../mobile.startup/util' ),\n\tView = require( '../mobile.startup/View' ),\n\tuser = mw.user;\n\n/**\n * @extends View\n */\nclass BetaOptInPanel extends View {\n\t/**\n\t * @param {Object} props\n\t * @param {string} props.postUrl url for form to post to\n\t * @param {Function} [props.onCancel]\n\t */\n\tconstructor( props ) {\n\t\tsuper(\n\t\t\tutil.extend(\n\t\t\t\t{\n\t\t\t\t\tisTemplateMode: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\t'click .optin': '_onOptin',\n\t\t\t\t\t\t'click .cancel': props.onCancel\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tprops\n\t\t\t)\n\t\t);\n\t}\n\n\t/** @inheritdoc */\n\tpostRender() {\n\t\tthis.$el.find( '.message' ).append(\n\t\t\tthis.options.buttons.map( function ( button ) {\n\t\t\t\treturn button.$el;\n\t\t\t} )\n\t\t);\n\t}\n\n\t/**\n\t * Cancel event handler\n\t * @param {jQuery.Event} ev\n\t */\n\t_onOptin( ev ) {\n\t\tthis.$el.find( ev.currentTarget ).closest( 'form' ).trigger( 'submit' );\n\t}\n\n\t/**\n\t * @inheritdoc\n\t * @type {Object}\n\t */\n\tget template() {\n\t\treturn util.template( `\n\t<div class=\"beta-opt-in-panel panel panel-inline visible\">\n\t\t<form class=\"message content\" action=\"{{postUrl}}\" method=\"POST\">\n\t\t\t<p>{{text}}</p>\n\t\t\t<input type=\"hidden\" name=\"updateSingleOption\" value=\"enableBeta\">\n\t\t\t<input type=\"hidden\" name=\"enableBeta\" value=\"true\">\n\t\t\t<input type=\"hidden\" name=\"token\" value=\"{{editToken}}\">\n\t\t</form>\n\t</div>\n\t` );\n\t}\n\n\t/**\n\t * @inheritdoc\n\t * @mixes View#defaults\n\t * @type {Object}\n\t */\n\tget defaults() {\n\t\treturn util.extend(\n\t\t\t{},\n\t\t\tView.prototype.defaults,\n\t\t\t{\n\t\t\t\tpostUrl: undefined,\n\t\t\t\teditToken: user.tokens.get( 'csrfToken' ),\n\t\t\t\ttext: mw.msg( 'mobile-frontend-panel-betaoptin-msg' ),\n\t\t\t\tbuttons: [\n\t\t\t\t\tnew Button( {\n\t\t\t\t\t\tprogressive: true,\n\t\t\t\t\t\tadditionalClassNames: 'optin',\n\t\t\t\t\t\tlabel: mw.msg( 'mobile-frontend-panel-ok' )\n\t\t\t\t\t} ),\n\t\t\t\t\tnew Button( {\n\t\t\t\t\t\tadditionalClassNames: 'cancel',\n\t\t\t\t\t\tlabel: mw.msg( 'mobile-frontend-panel-cancel' )\n\t\t\t\t\t} )\n\t\t\t\t]\n\t\t\t}\n\t\t);\n\t}\n}\n\nmodule.exports = BetaOptInPanel;\n","/* global $ */\nvar M = require( '../mobile.startup/moduleLoaderSingleton' ),\n\tutil = require( '../mobile.startup/util' ),\n\teditorLoadingOverlay = require( './editorLoadingOverlay' ),\n\tOverlayManager = require( '../mobile.startup/OverlayManager' ),\n\t// #ca-edit, .mw-editsection are standard MediaWiki elements\n\t// .edit-link comes from MobileFrontend user page creation CTA\n\t$allEditLinks = $( '#ca-edit, .mw-editsection a, .edit-link' ),\n\tuser = mw.user,\n\tpopup = require( '../mobile.startup/toast' ),\n\tCtaDrawer = require( '../mobile.startup/CtaDrawer' ),\n\t// FIXME: Disable on IE < 10 for time being\n\tblacklisted = /MSIE \\d\\./.test( navigator.userAgent ),\n\tcontentModel = mw.config.get( 'wgPageContentModel' ),\n\tveConfig = mw.config.get( 'wgVisualEditorConfig' ),\n\teditCount = mw.config.get( 'wgUserEditCount' ),\n\teditorPath = /^\\/editor\\/(\\d+|all)$/;\n\n/**\n * Event handler for edit link clicks. Will prevent default link\n * behaviour and will not allow propagation\n * @method\n * @ignore\n * @param {HTMLElement} elem\n * @param {jQuery.Event} ev\n * @param {Router} router\n */\nfunction onEditLinkClick( elem, ev, router ) {\n\tvar section = ( new mw.Uri( elem.href ) ).query.section || 'all';\n\tif ( $allEditLinks.length === 1 ) {\n\t\t// If section edit links are not available, the only edit link\n\t\t// should allow editing the whole page (T232170)\n\t\tsection = 'all';\n\t}\n\trouter.navigate( '#/editor/' + section );\n\t// DO NOT USE stopPropagation or you'll break click tracking in WikimediaEvents\n\t// You DO NOT NEED to\n\t// prevent folding section when clicking Edit by stopping propagation\n\t// as this is a concern of the Toggler class and taken care of by inspecting\n\t// !ev.target.href (see Toggler.js)\n\t// avoid navigating to ?action=edit\n\tev.preventDefault();\n}\n\n/**\n * Retrieve the user's preferred editor setting. If none is set, return the default\n * editor for this wiki.\n * @method\n * @ignore\n * @return {string} Either 'VisualEditor' or 'SourceEditor'\n */\nfunction getPreferredEditor() {\n\tvar preferredEditor = mw.storage.get( 'preferredEditor' );\n\tif ( preferredEditor ) {\n\t\treturn preferredEditor;\n\t}\n\tswitch ( mw.config.get( 'wgMFDefaultEditor' ) ) {\n\t\tcase 'source':\n\t\t\treturn 'SourceEditor';\n\t\tcase 'visual':\n\t\t\treturn 'VisualEditor';\n\t\tcase 'preference':\n\t\t\treturn mw.user.options.get( 'visualeditor-editor' ) === 'visualeditor' ? 'VisualEditor' : 'SourceEditor';\n\t}\n\t// In the event of misconfiguration, fall back to source\n\treturn 'SourceEditor';\n}\n\n/**\n * Initialize the edit button so that it launches the editor interface when clicked.\n * @method\n * @ignore\n * @param {Page} page The page to edit.\n * @param {Skin} skin\n * @param {PageHTMLParser} currentPageHTMLParser\n * @param {Router} router\n */\nfunction setupEditor( page, skin, currentPageHTMLParser, router ) {\n\tvar uri, fragment, editorOverride,\n\t\toverlayManager = OverlayManager.getSingleton(),\n\t\tisNewPage = page.id === 0;\n\n\t$allEditLinks.on( 'click', function ( ev ) {\n\t\tonEditLinkClick( this, ev, overlayManager.router );\n\t} );\n\toverlayManager.add( editorPath, function ( sectionId ) {\n\t\tvar\n\t\t\tscrollbarWidth = window.innerWidth - document.documentElement.clientWidth,\n\t\t\tscrollTop = window.pageYOffset,\n\t\t\t$content = $( '#mw-content-text' ),\n\t\t\teditorOptions = {\n\t\t\t\toverlayManager: overlayManager,\n\t\t\t\tcurrentPageHTMLParser: currentPageHTMLParser,\n\t\t\t\tfakeScroll: 0,\n\t\t\t\tapi: new mw.Api(),\n\t\t\t\tlicenseMsg: skin.getLicenseMsg(),\n\t\t\t\ttitle: page.title,\n\t\t\t\ttitleObj: page.titleObj,\n\t\t\t\tisAnon: user.isAnon(),\n\t\t\t\tisNewPage: isNewPage,\n\t\t\t\teditCount: editCount,\n\t\t\t\toldId: mw.util.getParamValue( 'oldid' ),\n\t\t\t\tcontentLang: $content.attr( 'lang' ),\n\t\t\t\tcontentDir: $content.attr( 'dir' ),\n\t\t\t\tsessionId: user.generateRandomSessionId()\n\t\t\t},\n\t\t\tanimationDelayDeferred, abortableDataPromise, loadingOverlay, overlayPromise,\n\t\t\tinitMechanism = mw.util.getParamValue( 'redlink' ) ? 'new' : 'click';\n\n\t\tif ( sectionId !== 'all' ) {\n\t\t\teditorOptions.sectionId = page.isWikiText() ? +sectionId : null;\n\t\t}\n\n\t\tfunction showLoading() {\n\t\t\tvar $page, $content, $sectionTop, fakeScroll, enableVisualSectionEditing;\n\n\t\t\t$( document.body ).addClass( 've-loading' );\n\n\t\t\t$page = $( '#mw-mf-page-center' );\n\t\t\t$content = $( '#content' );\n\t\t\tif ( sectionId === '0' || sectionId === 'all' ) {\n\t\t\t\t$sectionTop = $( '#bodyContent' );\n\t\t\t} else {\n\t\t\t\t$sectionTop = $( '[data-section=\"' + sectionId + '\"]' )\n\t\t\t\t\t.closest( 'h1, h2, h3, h4, h5, h6' );\n\t\t\t\t// When loading on action=edit URLs, there is no page content\n\t\t\t\tif ( !$sectionTop.length ) {\n\t\t\t\t\t$sectionTop = $( '#bodyContent' );\n\t\t\t\t}\n\t\t\t}\n\t\t\t// If there was a scrollbar that was hidden when the overlay was shown, add a margin\n\t\t\t// with the same width. This is mostly so that developers testing this on desktop\n\t\t\t// don't go crazy when the fake scroll fails to line up.\n\t\t\t$page.css( {\n\t\t\t\t'padding-right': '+=' + scrollbarWidth,\n\t\t\t\t'box-sizing': 'border-box'\n\t\t\t} );\n\t\t\t// Pretend that we didn't just scroll the page to the top.\n\t\t\t$page.prop( 'scrollTop', scrollTop );\n\t\t\t// Then, pretend that we're scrolling to the position of the clicked heading.\n\t\t\tfakeScroll = $sectionTop[0].getBoundingClientRect().top;\n\t\t\t// Adjust for height of the toolbar.\n\t\t\tfakeScroll -= 48;\n\t\t\tif ( shouldLoadVisualEditor() ) {\n\t\t\t\tenableVisualSectionEditing = veConfig.enableVisualSectionEditing === true ||\n\t\t\t\t\t// === ve.init.mw.MobileArticleTarget.static.trackingName\n\t\t\t\t\tveConfig.enableVisualSectionEditing === 'mobile';\n\t\t\t\tif ( sectionId === '0' || sectionId === 'all' || enableVisualSectionEditing ) {\n\t\t\t\t\t// Adjust for surface padding. Only needed if we're at the beginning of the doc.\n\t\t\t\t\tfakeScroll -= 16;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif ( sectionId === '0' || sectionId === 'all' ) {\n\t\t\t\t\tfakeScroll -= 16;\n\t\t\t\t}\n\t\t\t}\n\t\t\t$content.css( {\n\t\t\t\t// Use transform instead of scroll for smoother animation (via CSS transitions).\n\t\t\t\ttransform: 'translate( 0, ' + -fakeScroll + 'px )',\n\t\t\t\t// If the clicked heading is near the end of the page, we might need to insert\n\t\t\t\t// some extra space to allow us to scroll \"beyond the end\" of the page.\n\t\t\t\t'padding-bottom': '+=' + fakeScroll,\n\t\t\t\t'margin-bottom': '-=' + fakeScroll\n\t\t\t} );\n\t\t\teditorOptions.fakeScroll = fakeScroll;\n\t\t\tsetTimeout( animationDelayDeferred.resolve, 500 );\n\t\t}\n\n\t\tfunction clearLoading() {\n\t\t\tif ( abortableDataPromise && abortableDataPromise.abort ) {\n\t\t\t\tabortableDataPromise.abort();\n\t\t\t}\n\n\t\t\t$( '#content' ).css( {\n\t\t\t\ttransform: '',\n\t\t\t\t'padding-bottom': '',\n\t\t\t\t'margin-bottom': ''\n\t\t\t} );\n\t\t\t$( '#mw-mf-page-center' ).css( {\n\t\t\t\t'padding-right': '',\n\t\t\t\t'box-sizing': ''\n\t\t\t} );\n\n\t\t\t$( document.body ).removeClass( 've-loading' );\n\t\t}\n\n\t\t/**\n\t\t * Log init event to edit schema.\n\t\t * Need to log this from outside the Overlay object because that module\n\t\t * won't have loaded yet.\n\t\t * @private\n\t\t * @ignore\n\t\t * @param {string} editor name e.g. wikitext or visualeditor\n\t\t * @method\n\t\t */\n\t\tfunction logInit( editor ) {\n\t\t\tmw.track( 'mf.schemaEditAttemptStep', {\n\t\t\t\taction: 'init',\n\t\t\t\ttype: 'section',\n\t\t\t\tmechanism: initMechanism,\n\t\t\t\t/* eslint-disable camelcase */\n\t\t\t\teditor_interface: editor,\n\t\t\t\tediting_session_id: editorOptions.sessionId\n\t\t\t\t/* eslint-enable camelcase */\n\t\t\t} );\n\t\t}\n\n\t\t/**\n\t\t * Check whether VisualEditor should be loaded\n\t\t * @private\n\t\t * @ignore\n\t\t * @method\n\t\t * @return {bool}\n\t\t */\n\t\tfunction shouldLoadVisualEditor() {\n\t\t\tvar\n\t\t\t\t// FIXME: Should we consider default site options and user prefs?\n\t\t\t\tisVisualEditorEnabled = !!veConfig,\n\t\t\t\tpreferredEditor = getPreferredEditor(),\n\t\t\t\tvisualEditorNamespaces = ( veConfig && veConfig.namespaces ) || [];\n\n\t\t\treturn isVisualEditorEnabled &&\n\n\t\t\t\t// Only for pages with a wikitext content model\n\t\t\t\tpage.isWikiText() &&\n\n\t\t\t\t// Only in enabled namespaces\n\t\t\t\tvisualEditorNamespaces.indexOf( mw.config.get( 'wgNamespaceNumber' ) ) !== -1 &&\n\n\t\t\t\t// Not on pages which are outputs of the Page Translation feature\n\t\t\t\tmw.config.get( 'wgTranslatePageTranslation' ) !== 'translation' &&\n\n\t\t\t\t(\n\t\t\t\t\t// If the user prefers the VisualEditor or the user has no preference and\n\t\t\t\t\t// the VisualEditor is the default editor for this wiki\n\t\t\t\t\tpreferredEditor === 'VisualEditor' ||\n\t\t\t\t\t// We've loaded it via the URL for this request\n\t\t\t\t\teditorOverride === 'VisualEditor'\n\t\t\t\t) &&\n\n\t\t\t\teditorOverride !== 'SourceEditor';\n\t\t}\n\n\t\t/**\n\t\t * Load source editor\n\t\t * @private\n\t\t * @ignore\n\t\t * @method\n\t\t * @return {jQuery.Promise} Promise resolved with the editor overlay\n\t\t */\n\t\tfunction loadSourceEditor() {\n\t\t\tlogInit( 'wikitext' );\n\t\t\t// Inform other interested code that we're loading the editor\n\t\t\tmw.hook( 'mobileFrontend.editorOpening' ).fire();\n\n\t\t\treturn mw.loader.using( 'mobile.editor.overlay' ).then( function () {\n\t\t\t\tvar SourceEditorOverlay = M.require( 'mobile.editor.overlay/SourceEditorOverlay' );\n\t\t\t\treturn new SourceEditorOverlay( editorOptions );\n\t\t\t} );\n\t\t}\n\n\t\t/**\n\t\t * Load visual editor. If it fails to load for any reason, load the source editor instead.\n\t\t * @private\n\t\t * @ignore\n\t\t * @method\n\t\t * @return {jQuery.Promise} Promise resolved with the editor overlay\n\t\t */\n\t\tfunction loadVisualEditorMaybe() {\n\t\t\tlogInit( 'visualeditor' );\n\t\t\t// Inform other interested code that we're loading the editor\n\t\t\tmw.hook( 'mobileFrontend.editorOpening' ).fire();\n\n\t\t\teditorOptions.mode = 'visual';\n\t\t\teditorOptions.dataPromise = mw.loader.using( 'ext.visualEditor.targetLoader' ).then( function () {\n\t\t\t\tabortableDataPromise = mw.libs.ve.targetLoader.requestPageData(\n\t\t\t\t\teditorOptions.mode,\n\t\t\t\t\teditorOptions.titleObj.getPrefixedDb(),\n\t\t\t\t\t{\n\t\t\t\t\t\tsessionStore: true,\n\t\t\t\t\t\tsection: editorOptions.sectionId === undefined ?\n\t\t\t\t\t\t\tnull : editorOptions.sectionId,\n\t\t\t\t\t\toldId: editorOptions.oldId || undefined,\n\t\t\t\t\t\t// Should be ve.init.mw.MobileArticleTarget.static.trackingName,\n\t\t\t\t\t\t// but the class hasn't loaded yet.\n\t\t\t\t\t\ttargetName: 'mobile'\n\t\t\t\t\t} );\n\t\t\t\treturn abortableDataPromise;\n\t\t\t} );\n\n\t\t\treturn mw.loader.using( 'ext.visualEditor.targetLoader' )\n\t\t\t\t.then( function () {\n\t\t\t\t\tmw.libs.ve.targetLoader.addPlugin( 'mobile.editor.ve' );\n\t\t\t\t\treturn mw.libs.ve.targetLoader.loadModules( editorOptions.mode );\n\t\t\t\t} )\n\t\t\t\t.then( function () {\n\t\t\t\t\tvar VisualEditorOverlay = M.require( 'mobile.editor.overlay/VisualEditorOverlay' ),\n\t\t\t\t\t\tSourceEditorOverlay = M.require( 'mobile.editor.overlay/SourceEditorOverlay' );\n\t\t\t\t\teditorOptions.SourceEditorOverlay = SourceEditorOverlay;\n\t\t\t\t\treturn new VisualEditorOverlay( editorOptions );\n\t\t\t\t}, function () {\n\t\t\t\t\treturn loadSourceEditor();\n\t\t\t\t} );\n\t\t}\n\n\t\tanimationDelayDeferred = util.Deferred();\n\n\t\t// showLoading() has to run after the overlay has opened, which disables page scrolling.\n\t\t// clearLoading() has to run after the loading overlay is hidden in any way\n\t\t// (either when loading is aborted, or when the editor overlay is shown instead).\n\t\tloadingOverlay = editorLoadingOverlay( showLoading, clearLoading );\n\n\t\tif ( shouldLoadVisualEditor() ) {\n\t\t\toverlayPromise = loadVisualEditorMaybe();\n\t\t} else {\n\t\t\toverlayPromise = loadSourceEditor();\n\t\t}\n\n\t\t// Wait for the scroll animation to finish before we show the editor overlay\n\t\tutil.Promise.all( [ overlayPromise, animationDelayDeferred ] ).then( function ( overlay ) {\n\t\t\t// Wait for the data to load before we show the editor overlay\n\t\t\toverlay.getLoadingPromise().then( function () {\n\t\t\t\t// Make sure the user did not close the loading overlay while we were waiting\n\t\t\t\tvar overlayData = overlayManager.stack[0];\n\t\t\t\tif ( !overlayData || overlayData.overlay !== loadingOverlay ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// Show the editor!\n\t\t\t\toverlayManager.replaceCurrent( overlay );\n\t\t\t}, function ( error ) {\n\t\t\t\t// Could not load the editor.\n\t\t\t\toverlayManager.router.back();\n\t\t\t\tif ( error.show ) {\n\t\t\t\t\t// Probably a blockMessageDrawer returned because the user is blocked.\n\t\t\t\t\terror.show();\n\t\t\t\t} else {\n\t\t\t\t\tmw.notify( mw.msg( 'mobile-frontend-editor-error-loading' ) );\n\t\t\t\t}\n\t\t\t} );\n\t\t} );\n\n\t\treturn loadingOverlay;\n\t} );\n\n\t$( '#ca-edit a' ).prop( 'href', function ( i, href ) {\n\t\tvar uri = new mw.Uri( href );\n\t\t// By default the editor opens section 0 (lead section), rather than the whole article.\n\t\t// This might be changed in the future (T210659).\n\t\turi.query.section = 0;\n\t\treturn uri.toString();\n\t} );\n\n\tif ( !router.getPath() && ( mw.util.getParamValue( 'veaction' ) || mw.util.getParamValue( 'action' ) === 'edit' ) ) {\n\t\tif ( mw.util.getParamValue( 'veaction' ) === 'edit' ) {\n\t\t\teditorOverride = 'VisualEditor';\n\t\t} else if ( mw.util.getParamValue( 'veaction' ) === 'editsource' ) {\n\t\t\teditorOverride = 'SourceEditor';\n\t\t}\n\t\t// else: action=edit, for which we allow the default to take effect\n\t\tfragment = '#/editor/' + ( mw.util.getParamValue( 'section' ) || ( mw.util.getParamValue( 'action' ) === 'edit' && 'all' ) || '0' );\n\t\t// eslint-disable-next-line no-restricted-properties\n\t\tif ( window.history && history.pushState ) {\n\t\t\turi = mw.Uri();\n\t\t\tdelete uri.query.action;\n\t\t\tdelete uri.query.veaction;\n\t\t\tdelete uri.query.section;\n\t\t\t// Note: replaceState rather than pushState, because we're\n\t\t\t// just reformatting the URL to the equivalent-meaning for the\n\t\t\t// mobile site.\n\t\t\thistory.replaceState( null, document.title, uri.toString() + fragment );\n\t\t} else {\n\t\t\trouter.navigate( fragment );\n\t\t}\n\t}\n}\n\n/**\n * Hide any section id icons in the page. This will not hide the edit icon in the page action\n * menu.\n * @method\n * @ignore\n * @param {PageHTMLParser} currentPageHTMLParser\n */\nfunction hideSectionEditIcons( currentPageHTMLParser ) {\n\tcurrentPageHTMLParser.$el.find( '.mw-editsection' ).hide();\n}\n\n/**\n * Show a drawer with log in / sign up buttons.\n * @method\n * @ignore\n * @param {Router} router\n */\nfunction showLoginDrawer( router ) {\n\tvar drawer = new CtaDrawer( {\n\t\tcontent: mw.msg( 'mobile-frontend-editor-disabled-anon' ),\n\t\tsignupQueryParams: {\n\t\t\twarning: 'mobile-frontend-watchlist-signup-action'\n\t\t}\n\t} );\n\t$allEditLinks.on( 'click', function ( ev ) {\n\t\tdrawer.show();\n\t\tev.preventDefault();\n\t\treturn drawer;\n\t} );\n\trouter.route( editorPath, function () {\n\t\tdrawer.show();\n\t} );\n\trouter.checkRoute();\n}\n\n/**\n * Setup the editor if the user can edit the page otherwise show a sorry toast.\n * @method\n * @ignore\n * @param {Page} currentPage\n * @param {PageHTMLParser} currentPageHTMLParser\n * @param {Skin} skin\n * @param {Router} router\n */\nfunction init( currentPage, currentPageHTMLParser, skin, router ) {\n\tvar isReadOnly, isEditable, editErrorMessage, editRestrictions;\n\t// see: https://www.mediawiki.org/wiki/Manual:Interface/JavaScript#Page-specific\n\tisReadOnly = mw.config.get( 'wgMinervaReadOnly' );\n\tisEditable = !isReadOnly && mw.config.get( 'wgIsProbablyEditable' );\n\n\tif ( isEditable ) {\n\t\t// Edit button updated in setupEditor.\n\t\tsetupEditor( currentPage, skin, currentPageHTMLParser, router );\n\t} else {\n\t\thideSectionEditIcons( currentPageHTMLParser );\n\t\teditRestrictions = mw.config.get( 'wgRestrictionEdit' );\n\t\tif ( mw.user.isAnon() && Array.isArray( editRestrictions ) && editRestrictions.indexOf( '*' ) !== -1 ) {\n\t\t\tshowLoginDrawer( router );\n\t\t} else {\n\t\t\teditErrorMessage = isReadOnly ? mw.msg( 'apierror-readonly' ) : mw.msg( 'mobile-frontend-editor-disabled' );\n\t\t\tshowSorryToast( editErrorMessage, router );\n\t\t}\n\t}\n}\n\n/**\n * Wire up events that ensure we\n * show a toast message with sincere condolences when user navigates to\n * #/editor or clicks on an edit button\n * @method\n * @ignore\n * @param {string} msg Message for sorry message\n * @param {Router} router\n */\nfunction showSorryToast( msg, router ) {\n\t$allEditLinks.on( 'click', function ( ev ) {\n\t\tpopup.show( msg );\n\t\tev.preventDefault();\n\t} );\n\trouter.route( editorPath, function () {\n\t\tpopup.show( msg );\n\t} );\n\trouter.checkRoute();\n}\n\nmodule.exports = function ( currentPage, currentPageHTMLParser, skin ) {\n\tvar isMissing = currentPage.id === 0,\n\t\trouter = mw.loader.require( 'mediawiki.router' ),\n\t\tisEditingSupported = router.isSupported() && !blacklisted;\n\n\tif ( contentModel !== 'wikitext' ) {\n\t\t// Only load the wikitext editor on wikitext. Otherwise we'll rely on the fallback behaviour\n\t\t// (You can test this on MediaWiki:Common.css) ?action=edit url (T173800)\n\t\treturn;\n\t}\n\n\tif ( mw.util.getParamValue( 'undo' ) ) {\n\t\t// Our fancy editor doesn't support undo, but we can rely on the fallback.\n\t\treturn;\n\t}\n\n\tif ( !isEditingSupported ) {\n\t\t// Browser doesn't support mobile editor (or is blacklisted), use the fallback editor.\n\t\treturn;\n\t}\n\n\tif ( currentPage.inNamespace( 'file' ) && isMissing ) {\n\t\t// Is a new file page (enable upload image only) Bug 58311\n\t\tshowSorryToast( mw.msg( 'mobile-frontend-editor-uploadenable' ), router );\n\t} else {\n\t\t// Edit button is currently hidden. A call to init() will update it as needed.\n\t\tinit( currentPage, currentPageHTMLParser, skin, router );\n\t}\n};\n","var\n\tfakeToolbar = require( './fakeToolbar' ),\n\tOverlay = require( '../mobile.startup/Overlay' );\n\n/**\n * Like loadingOverlay(), but with a fake editor toolbar instead of the spinner.\n *\n * @param {Function} afterShow Callback which runs after overlay is shown\n * @param {Function} afterHide Callback which runs after overlay is hidden\n * @return {Overlay}\n */\nfunction editorLoadingOverlay( afterShow, afterHide ) {\n\tvar\n\t\t$fakeToolbar = fakeToolbar(),\n\t\toverlay = new Overlay( {\n\t\t\tclassName: 'overlay overlay-loading',\n\t\t\tnoHeader: true,\n\t\t\tisBorderBox: false,\n\t\t\tonBeforeExit: function ( exit ) {\n\t\t\t\texit();\n\t\t\t\tafterHide();\n\t\t\t}\n\t\t} );\n\n\toverlay.show = function () {\n\t\tOverlay.prototype.show.call( this );\n\t\tafterShow();\n\t};\n\n\t$fakeToolbar.appendTo( overlay.$el.find( '.overlay-content' ) );\n\n\t// Animate the toolbar sliding into place.\n\t$fakeToolbar.addClass( 'toolbar-hidden' );\n\tsetTimeout( function () {\n\t\t$fakeToolbar.addClass( 'toolbar-shown' );\n\t\tsetTimeout( function () {\n\t\t\t$fakeToolbar.addClass( 'toolbar-shown-done' );\n\t\t}, 250 );\n\t} );\n\n\treturn overlay;\n}\n\nmodule.exports = editorLoadingOverlay;\n","module.exports = function () {\n\tvar trackdebug = !!mw.util.getParamValue( 'trackdebug' );\n\n\tif ( !mw.config.exists( 'wgWMESchemaEditAttemptStepSamplingRate' ) ) {\n\t\treturn;\n\t}\n\n\t( function () {\n\t\tvar // Schema class is provided by ext.eventLogging\n\t\t\tSchema = mw.eventLog.Schema,\n\t\t\tuser = mw.user,\n\t\t\tsampleRate = mw.config.get( 'wgWMESchemaEditAttemptStepSamplingRate' ),\n\t\t\tactionPrefixMap = {\n\t\t\t\tfirstChange: 'first_change',\n\t\t\t\tsaveIntent: 'save_intent',\n\t\t\t\tsaveAttempt: 'save_attempt',\n\t\t\t\tsaveSuccess: 'save_success',\n\t\t\t\tsaveFailure: 'save_failure'\n\t\t\t},\n\t\t\ttiming = {},\n\t\t\t/**\n\t\t\t * Edit schema\n\t\t\t * https://meta.wikimedia.org/wiki/Schema:EditAttemptStep\n\t\t\t */\n\t\t\t/* eslint-disable camelcase */\n\t\t\tschemaEditAttemptStep = new Schema(\n\t\t\t\t'EditAttemptStep',\n\t\t\t\tsampleRate,\n\t\t\t\t{\n\t\t\t\t\tpage_id: mw.config.get( 'wgArticleId' ),\n\t\t\t\t\trevision_id: mw.config.get( 'wgRevisionId' ),\n\t\t\t\t\tpage_title: mw.config.get( 'wgPageName' ),\n\t\t\t\t\tpage_ns: mw.config.get( 'wgNamespaceNumber' ),\n\t\t\t\t\tuser_id: user.getId(),\n\t\t\t\t\tuser_class: user.isAnon() ? 'IP' : undefined,\n\t\t\t\t\tuser_editcount: mw.config.get( 'wgUserEditCount', 0 ),\n\t\t\t\t\tmw_version: mw.config.get( 'wgVersion' ),\n\t\t\t\t\tplatform: 'phone',\n\t\t\t\t\tintegration: 'page',\n\t\t\t\t\tpage_token: user.getPageviewToken(),\n\t\t\t\t\tsession_token: user.sessionId(),\n\t\t\t\t\tversion: 1\n\t\t\t\t}\n\t\t\t);\n\t\t\t/* eslint-enable camelcase */\n\n\t\tif ( mw.config.get( 'wgMFSchemaEditAttemptStepAnonymousUserId' ) ) {\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\tschemaEditAttemptStep.defaults.anonymous_user_token = mw.config.get( 'wgMFSchemaEditAttemptStepAnonymousUserId' );\n\t\t}\n\t\tif ( mw.config.get( 'wgMFSchemaEditAttemptStepBucket' ) ) {\n\t\t\tschemaEditAttemptStep.defaults.bucket = mw.config.get( 'wgMFSchemaEditAttemptStepBucket' );\n\t\t}\n\n\t\tfunction log() {\n\t\t\t// mw.log is a no-op unless resource loader is in debug mode, so\n\t\t\t// this allows trackdebug to work independently (T211698)\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.log.apply( console, arguments );\n\t\t}\n\n\t\tfunction computeDuration( action, event, timeStamp ) {\n\t\t\t// This is duplicated from the VisualEditor extension\n\t\t\t// (ve.init.mw.trackSubscriber.js). Changes to this should be kept in\n\t\t\t// sync with that file, so the data remains consistent.\n\t\t\tif ( event.timing !== undefined ) {\n\t\t\t\treturn event.timing;\n\t\t\t}\n\n\t\t\tswitch ( action ) {\n\t\t\t\tcase 'ready':\n\t\t\t\t\treturn timeStamp - timing.init;\n\t\t\t\tcase 'loaded':\n\t\t\t\t\treturn timeStamp - timing.init;\n\t\t\t\tcase 'firstChange':\n\t\t\t\t\treturn timeStamp - timing.ready;\n\t\t\t\tcase 'saveIntent':\n\t\t\t\t\treturn timeStamp - timing.ready;\n\t\t\t\tcase 'saveAttempt':\n\t\t\t\t\treturn timeStamp - timing.saveIntent;\n\t\t\t\tcase 'saveSuccess':\n\t\t\t\tcase 'saveFailure':\n\t\t\t\t\t// HERE BE DRAGONS: the caller must compute these themselves\n\t\t\t\t\t// for sensible results. Deliberately sabotage any attempts to\n\t\t\t\t\t// use the default by returning -1\n\t\t\t\t\tmw.log.warn( 'mf.schemaEditAttemptStep: Do not rely on default timing value for saveSuccess/saveFailure' );\n\t\t\t\t\treturn -1;\n\t\t\t\tcase 'abort':\n\t\t\t\t\tswitch ( event.abort_type ) {\n\t\t\t\t\t\tcase 'preinit':\n\t\t\t\t\t\t\treturn timeStamp - timing.init;\n\t\t\t\t\t\tcase 'nochange':\n\t\t\t\t\t\tcase 'switchwith':\n\t\t\t\t\t\tcase 'switchwithout':\n\t\t\t\t\t\tcase 'switchnochange':\n\t\t\t\t\t\tcase 'abandon':\n\t\t\t\t\t\t\treturn timeStamp - timing.ready;\n\t\t\t\t\t\tcase 'abandonMidsave':\n\t\t\t\t\t\t\treturn timeStamp - timing.saveAttempt;\n\t\t\t\t\t}\n\t\t\t\t\tmw.log.warn( 'mf.schemaEditAttemptStep: Unrecognized abort type', event.type );\n\t\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tmw.log.warn( 'mf.schemaEditAttemptStep: Unrecognized action', action );\n\t\t\treturn -1;\n\t\t}\n\n\t\tmw.trackSubscribe( 'mf.schemaEditAttemptStep', function ( topic, data, timeStamp ) {\n\t\t\tvar actionPrefix = actionPrefixMap[ data.action ] || data.action,\n\t\t\t\tduration = 0;\n\n\t\t\ttimeStamp = timeStamp || this.timeStamp; // I8e82acc12 back-compat\n\n\t\t\t// Schema's kind of a mess of special properties\n\t\t\tif ( data.action === 'init' || data.action === 'abort' || data.action === 'saveFailure' ) {\n\t\t\t\tdata[ actionPrefix + '_type' ] = data.type;\n\t\t\t}\n\t\t\tif ( data.action === 'init' || data.action === 'abort' ) {\n\t\t\t\tdata[ actionPrefix + '_mechanism' ] = data.mechanism;\n\t\t\t}\n\t\t\tif ( data.action !== 'init' ) {\n\t\t\t\t// Schema actually does have an init_timing field, but we don't want to\n\t\t\t\t// store it because it's not meaningful.\n\t\t\t\tduration = Math.round( computeDuration( data.action, data, timeStamp ) );\n\t\t\t\tdata[ actionPrefix + '_timing' ] = duration;\n\t\t\t}\n\t\t\tif ( data.action === 'saveFailure' ) {\n\t\t\t\tdata[ actionPrefix + '_message' ] = data.message;\n\t\t\t}\n\n\t\t\t// Remove renamed properties\n\t\t\tdelete data.type;\n\t\t\tdelete data.mechanism;\n\t\t\tdelete data.timing;\n\t\t\tdelete data.message;\n\t\t\t// eslint-disable-next-line camelcase\n\t\t\tdata.is_oversample =\n\t\t\t\t!mw.eventLog.inSample( 1 / sampleRate );\n\n\t\t\tif ( data.action === 'abort' && data.abort_type !== 'switchnochange' ) {\n\t\t\t\ttiming = {};\n\t\t\t} else {\n\t\t\t\ttiming[ data.action ] = timeStamp;\n\t\t\t}\n\n\t\t\t// Switching between visual and source produces a chain of\n\t\t\t// abort/ready/loaded events and no init event, so suppress them for\n\t\t\t// consistency with desktop VE's logging.\n\t\t\tif ( data.abort_type === 'switchnochange' ) {\n\t\t\t\t// The initial abort, flagged as a switch\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ( timing.abort ) {\n\t\t\t\t// An abort was previously logged\n\t\t\t\tif ( data.action === 'ready' ) {\n\t\t\t\t\t// Just discard the ready\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif ( data.action === 'loaded' ) {\n\t\t\t\t\t// Switch has finished; remove the abort timing so we stop discarding events.\n\t\t\t\t\tdelete timing.abort;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ( trackdebug ) {\n\t\t\t\tlog( topic + '.' + data.action, duration + 'ms', data, schemaEditAttemptStep.defaults );\n\t\t\t} else {\n\t\t\t\tschemaEditAttemptStep.log( data, (\n\t\t\t\t\tmw.config.get( 'wgWMESchemaEditAttemptStepOversample' ) ||\n\t\t\t\t\tmw.config.get( 'wgMFSchemaEditAttemptStepOversample' ) === 'all' ||\n\t\t\t\t\t// wikitext / visualeditor\n\t\t\t\t\tdata.editor_interface === mw.config.get( 'wgMFSchemaEditAttemptStepOversample' )\n\t\t\t\t) ? 1 : sampleRate );\n\t\t\t}\n\t\t} );\n\n\t}() );\n};\n","module.exports = function () {\n\t( function () {\n\t\tvar // Schema class provided by ext.eventLogging\n\t\t\tSchema = mw.eventLog.Schema,\n\t\t\t/**\n\t\t\t * MobileWebSearch schema\n\t\t\t * https://meta.wikimedia.org/wiki/Schema:MobileWebSearch\n\t\t\t */\n\t\t\tschemaMobileWebSearch = new Schema(\n\t\t\t\t'MobileWebSearch',\n\t\t\t\t// todo: use a default value of 0 once config lands in production.\n\t\t\t\tmw.config.get( 'wgMFSchemaSearchSampleRate', 1 / 1000 ),\n\t\t\t\t/**\n\t\t\t\t * @property {Object} defaults Default options hash.\n\t\t\t\t * @property {string} defaults.platform Always \"mobileweb\"\n\t\t\t\t * @property {string} defaults.platformVersion The version of MobileFrontend\n\t\t\t\t *  that the user is using. One of \"stable\" or \"beta\"\n\t\t\t\t */\n\t\t\t\t{\n\t\t\t\t\tplatform: 'mobileweb',\n\t\t\t\t\tplatformVersion: mw.config.get( 'wgMFMode' )\n\t\t\t\t}\n\t\t\t);\n\n\t\tmw.trackSubscribe( 'mf.schemaMobileWebSearch', function ( topic, data ) {\n\t\t\tschemaMobileWebSearch.log( data );\n\t\t} );\n\t}() );\n};\n","module.exports = function () {\n\tvar trackdebug = !!mw.util.getParamValue( 'trackdebug' );\n\n\tif ( !mw.config.exists( 'wgWMESchemaEditAttemptStepSamplingRate' ) ) {\n\t\treturn;\n\t}\n\n\t// VisualEditorFeatureUse is intended to log whenever EditAttemptStep\n\t// does, so this file references its config for sampling rates and\n\t// oversampling.\n\n\t( function () {\n\t\tvar // Schema class provided by ext.eventLogging\n\t\t\tSchema = mw.eventLog.Schema,\n\t\t\tsampleRate = mw.config.get( 'wgWMESchemaEditAttemptStepSamplingRate' ),\n\t\t\t/**\n\t\t\t * Feature use schema\n\t\t\t * https://meta.wikimedia.org/wiki/Schema:VisualEditorFeatureUse\n\t\t\t */\n\t\t\tschemaVisualEditorFeatureUse = new Schema(\n\t\t\t\t'VisualEditorFeatureUse',\n\t\t\t\tsampleRate\n\t\t\t);\n\n\t\tfunction log() {\n\t\t\t// mw.log is a no-op unless resource loader is in debug mode, so\n\t\t\t// this allows trackdebug to work independently (T211698)\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.log.apply( console, arguments );\n\t\t}\n\n\t\tmw.trackSubscribe( 'mf.schemaVisualEditorFeatureUse', function ( topic, data ) {\n\t\t\tvar event = {\n\t\t\t\tfeature: data.feature,\n\t\t\t\taction: data.action,\n\t\t\t\teditingSessionId: data.editing_session_id\n\t\t\t};\n\n\t\t\tif ( trackdebug ) {\n\t\t\t\tlog( topic, event );\n\t\t\t} else {\n\t\t\t\tschemaVisualEditorFeatureUse.log( event, (\n\t\t\t\t\tmw.config.get( 'wgWMESchemaEditAttemptStepOversample' ) ||\n\t\t\t\t\tmw.config.get( 'wgMFSchemaEditAttemptStepOversample' ) === 'visualeditor' ||\n\t\t\t\t\tmw.config.get( 'wgMFSchemaEditAttemptStepOversample' ) === 'all'\n\t\t\t\t) ? 1 : sampleRate );\n\t\t\t}\n\t\t} );\n\n\t}() );\n};\n","/* global $ */\n\n// FIXME: make this an object with a constructor to facilitate testing\n// (see https://bugzilla.wikimedia.org/show_bug.cgi?id=44264)\n/**\n * mobileFrontend namespace\n * @class mw.mobileFrontend\n * @singleton\n */\nvar skin,\n\tstorage = mw.storage,\n\ttoggling = require( './toggling' ),\n\tskinName = mw.config.get( 'skin' ),\n\tisPageContentModelEditable = mw.config.get( 'wgMFIsPageContentModelEditable' ),\n\teditor = require( './editor' ),\n\tcurrentPage = require( '../mobile.startup/currentPage' )(),\n\tcurrentPageHTMLParser = require( '../mobile.startup/currentPageHTMLParser' )(),\n\tBetaOptInPanel = require( './BetaOptInPanel' ),\n\tutil = mw.util,\n\tmfUtil = require( '../mobile.startup/util' ),\n\t$window = mfUtil.getWindow(),\n\t$html = mfUtil.getDocument(),\n\tuser = mw.user,\n\texperiments = mw.experiments,\n\tactiveExperiments = mw.config.get( 'wgMFExperiments' ) || {},\n\tSkin = require( '../mobile.startup/Skin' ),\n\teventBus = require( '../mobile.startup/eventBusSingleton' ),\n\tschemaMobileWebSearch = require( './eventLogging/schemaMobileWebSearch' ),\n\tschemaEditAttemptStep = require( './eventLogging/schemaEditAttemptStep' ),\n\tschemaVisualEditorFeatureUse = require( './eventLogging/schemaVisualEditorFeatureUse' );\n\nskin = Skin.getSingleton();\n\n/**\n * Given 2 functions, it returns a function that will run both with it's\n * context and parameters and return the results combined\n * @private\n * @param {Function} fn1\n * @param {Function} fn2\n * @return {Function} which returns the results of [fn1, fn2]\n */\nfunction apply2( fn1, fn2 ) {\n\treturn function () {\n\t\treturn [\n\t\t\tfn1.apply( this, arguments ),\n\t\t\tfn2.apply( this, arguments )\n\t\t];\n\t};\n}\n\n/**\n * The `window`'s resize event debounced at 100 ms.\n * The `resize:throttled` event is the `window`'s\n * resize event throttled to 200 ms.\n * @event resize\n */\n\n/**\n * The `window`'s scroll event debounced at 100 ms.\n * The `scroll:throttled` event is the `window`'s\n * scroll event throttled to 200 ms.\n * @event scroll\n */\n\n$window\n\t.on( 'resize', apply2(\n\t\t$.debounce( 100, function () { eventBus.emit( 'resize' ); } ),\n\t\t$.throttle( 200, function () { eventBus.emit( 'resize:throttled' ); } )\n\t) )\n\t.on( 'scroll', apply2(\n\t\t$.debounce( 100, function () { eventBus.emit( 'scroll' ); } ),\n\t\t$.throttle( 200, function () { eventBus.emit( 'scroll:throttled' ); } )\n\t) );\n\n/**\n * Displays a prompt to ask the user to join the mobile beta mode.\n *\n * @private\n * @param {Object} experiment sampling data\n * @param {Page} page\n * @param {PageHTMLParser} pageHTMLParser\n */\nfunction displayBetaOptIn( experiment, page, pageHTMLParser ) {\n\tvar betaOptInPanel, inStable, inSample,\n\t\ttoken = storage.get( 'mobile-betaoptin-token' );\n\n\t// local storage is supported in this case, when ~ means it was dismissed\n\tif ( token !== false && token !== '~' &&\n\t\t!page.isMainPage() && !page.inNamespace( 'special' )\n\t) {\n\t\tif ( !token ) {\n\t\t\ttoken = user.generateRandomSessionId();\n\t\t\tstorage.set( 'mobile-betaoptin-token', token );\n\t\t}\n\n\t\tinStable = mw.config.get( 'wgMFMode' ) === 'stable';\n\t\tinSample = experiments.getBucket( experiment, token ) === 'A';\n\t\tif ( inStable && ( inSample || util.getParamValue( 'debug' ) ) ) {\n\t\t\tbetaOptInPanel = new BetaOptInPanel( {\n\t\t\t\tpostUrl: util.getUrl( 'Special:MobileOptions', {\n\t\t\t\t\treturnto: page.title\n\t\t\t\t} ),\n\t\t\t\tonCancel: function ( ev ) {\n\t\t\t\t\tev.preventDefault();\n\t\t\t\t\tstorage.set( 'mobile-betaoptin-token', '~' );\n\t\t\t\t\tthis.remove();\n\t\t\t\t}\n\t\t\t} );\n\n\t\t\tbetaOptInPanel.appendTo( pageHTMLParser.getLeadSectionElement() );\n\t\t}\n\n\t\t// let the interested parties e.g. QuickSurveys know whether the panel is shown\n\t\tmw.track( 'mobile.betaoptin', {\n\t\t\tisPanelShown: betaOptInPanel !== undefined\n\t\t} );\n\t}\n}\n\n/**\n * Updates the font size based on the current value in storage\n */\nfunction updateFontSize() {\n\t// FIXME: Ideally 'regular' would come from a shared constant\n\t// (currently not possible without using webpack)\n\tvar userFontSize = storage.get( 'userFontSize', 'regular' );\n\t$html.addClass( 'mf-font-size-' + userFontSize );\n}\n\n// Font must be updated on back button press as users may click\n// back after changing font.\n$window.on( 'pageshow', function () {\n\tupdateFontSize();\n} );\nupdateFontSize();\n\nif ( activeExperiments.betaoptin ) {\n\tdisplayBetaOptIn( activeExperiments.betaoptin, currentPage, currentPageHTMLParser );\n}\n\n// Recruit volunteers through the console\n// (note console.log may not be a function so check via apply)\n/* eslint-disable no-console */\nif ( window.console && window.console.log && window.console.log.apply &&\n\t\tmw.config.get( 'wgMFEnableJSConsoleRecruitment' ) ) {\n\tconsole.log( mw.msg( 'mobile-frontend-console-recruit' ) );\n}\n/* eslint-enable no-console */\n\n// setup editor\nif ( !currentPage.inNamespace( 'special' ) && isPageContentModelEditable ) {\n\t// TODO: Mobile editor doesn't work well with other skins yet (it looks horribly broken\n\t// without some styles that are only defined by Minerva).\n\tif ( skinName === 'minerva' ) {\n\t\t// TODO: This code should not even be loaded on desktop.\n\t\t// Remove this check when that is fixed (T216537).\n\t\tif ( mw.config.get( 'wgMFMode' ) !== null ) {\n\t\t\teditor( currentPage, currentPageHTMLParser, skin );\n\t\t}\n\t}\n}\n\ntoggling();\n\nmw.mobileFrontend.deprecate( 'mobile.init/skin', skin,\n\t'instance of mobile.startup/Skin. Minerva should have no dependencies on mobile.init' );\n\n// Set up recording for the events we track. The module 'ext.eventLogging'\n// should already be loaded (this doesn't trigger a new HTTP request), but we\n// don't specify a hard dependency because EventLogging may not be installed.\nmw.loader.using( 'ext.eventLogging' ).then( function () {\n\tschemaMobileWebSearch();\n\tschemaEditAttemptStep();\n\tschemaVisualEditorFeatureUse();\n} );\n","/* global $ */\nmodule.exports = function () {\n\tvar\n\t\t$contentContainer = $( '#mw-content-text > .mw-parser-output' ),\n\t\tcurrentPage = require( '../mobile.startup/currentPage' )(),\n\t\tToggler = require( '../mobile.startup/Toggler' ),\n\t\teventBus = require( '../mobile.startup/eventBusSingleton' );\n\n\t// If there was no mw-parser-output wrapper, just use the parent.\n\tif ( $contentContainer.length === 0 ) {\n\t\t$contentContainer = $( '#mw-content-text' );\n\t}\n\n\t/**\n\t * Initialises toggling code.\n\t *\n\t * @method\n\t * @param {JQuery.Object} $container to enable toggling on\n\t * @param {string} prefix a prefix to use for the id.\n\t * @param {Page} page The current page\n\t * @ignore\n\t */\n\tfunction init( $container, prefix, page ) {\n\t\t// Distinguish headings in content from other headings.\n\t\t$container.find( '> h1,> h2,> h3,> h4,> h5,> h6' ).addClass( 'section-heading' )\n\t\t\t.removeAttr( 'onclick' );\n\t\t// Cleanup global as it is no longer needed. We check if it's undefined because\n\t\t// there is no guarantee this won't be run on other skins e.g. Vector or cached HTML.\n\t\tif ( window.mfTempOpenSection !== undefined ) {\n\t\t\tdelete window.mfTempOpenSection;\n\t\t}\n\t\t// eslint-disable-next-line no-new\n\t\tnew Toggler( {\n\t\t\t$container: $container,\n\t\t\tprefix: prefix,\n\t\t\tpage: page,\n\t\t\teventBus: eventBus\n\t\t} );\n\t}\n\n\tif (\n\t\t// Avoid this running on Watchlist.\n\t\t!currentPage.inNamespace( 'special' ) &&\n\t\tmw.config.get( 'wgAction' ) === 'view'\n\t) {\n\t\tinit( $contentContainer, 'content-', currentPage );\n\t}\n};\n"],"sourceRoot":""}